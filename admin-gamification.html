<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Operations - Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a1a;
            color: #f5f5f5;
            min-height: 100vh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="none" stroke="white" stroke-width="2"/></svg>');
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .auth-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            background: #2c2c2c;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin: 2rem auto;
            border: 1px solid #444;
        }
        
        .auth-container h2 {
            text-align: center;
            color: #d4af37;
            margin-bottom: 20px;
            font-family: 'Times New Roman', serif;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
        }
        
        .auth-form input {
            margin-bottom: 15px;
            padding: 12px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 16px;
            color: white;
        }
        
        .auth-form button {
            background-color: #8B0000;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        
        .auth-form button:hover {
            background-color: #A52A2A;
        }
        
        .error-message {
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
            min-height: 20px;
        }
        
        .success-message {
            color: #4CAF50;
        }
        
        header {
            background-color: #2c2c2c;
            color: #d4af37;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #8B0000;
            font-family: 'Times New Roman', serif;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 5rem auto 2rem;
            padding: 0 1rem;
            min-height: 1200px;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #8B0000;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #A52A2A;
        }
        
        .btn-success {
            background-color: #2e8b57;
            color: white;
        }
        
        .btn-warning {
            background-color: #d4af37;
            color: #1a1a1a;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-info {
            background-color: #4682b4;
            color: white;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: #3a3a3a;
            border: 1px solid #444;
            border-bottom: none;
            margin-right: 0.25rem;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            color: #ccc;
        }
        
        .tab.active {
            background: #2c2c2c;
            border-bottom: 1px solid #2c2c2c;
            margin-bottom: -1px;
            font-weight: 500;
            color: #d4af37;
        }
        
        .tab-content {
            display: none;
            background: #2c2c2c;
            border-radius: 0 8px 8px 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #444;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            color: #d4af37;
            margin-bottom: 1.5rem;
            font-family: 'Times New Roman', serif;
            border-bottom: 1px solid #444;
            padding-bottom: 0.5rem;
        }
        
        .rankings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .rankings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .ranking-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #555;
        }
        
        .ranking-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #555;
        }
        
        .ranking-item:last-child {
            border-bottom: none;
        }
        
        .ranking-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #d4af37;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .customer-name {
            font-weight: 500;
        }
        
        .customer-email {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .respect-points {
            background: #8B0000;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .geographical-map {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #555;
            margin-bottom: 2rem;
        }
        
        .families-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            width: 100%;
        }
        
        .family-card {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #555;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .family-name {
            color: #d4af37;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .family-stats {
            font-size: 0.9rem;
            color: #ccc;
        }

        .geographical-location {
            font-size: 0.8rem;
            color: #d4af37;
            font-weight: bold;
            font-style: italic;
        }

        .location-badge {
            background: #8B0000;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .jobs-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .jobs-management {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #d4af37;
        }
        
        .form-control {
            width: 100%;
            padding: 0.7rem;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 1rem;
            color: white;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .jobs-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .job-item {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #555;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .job-title {
            font-weight: 500;
            color: #d4af37;
        }
        
        .job-points {
            background: #d4af37;
            color: #1a1a1a;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .job-description {
            color: #ccc;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .job-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .job-requests-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .job-request-item {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #555;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .request-type {
            background: #8B0000;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .request-date {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .request-details {
            margin-bottom: 1rem;
        }
        
        .request-user {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .request-content {
            color: #ccc;
            margin-bottom: 0.5rem;
        }
        
        .request-points {
            color: #d4af37;
            font-weight: bold;
        }
        
        .request-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .vault-requests-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .vault-request-item {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #555;
        }
        
        .vault-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .vault-service {
            background: #4682b4;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .vault-urgency {
            background: #d4af37;
            color: #1a1a1a;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .urgent {
            background: #8B0000;
            color: white;
        }
        
        .vault-details {
            margin-bottom: 1rem;
        }
        
        .vault-user {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .vault-content {
            color: #ccc;
            margin-bottom: 0.5rem;
        }
        
        .vault-contact {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .vault-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            border: 5px solid #3a3a3a;
            border-top: 5px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #ccc;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d4af37;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }

        .back-to-overview {
            background: #d4af37;
            color: #1a1a1a;
            margin-left: 10px;
        }
        
        .leading-family-card {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 1.5rem;
            border: 2px solid #d4af37;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            grid-column: 1 / -1;
        }
        
        .leading-family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .leading-family-badge {
            background: #d4af37;
            color: #1a1a1a;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 1rem;
            display: inline-block;
        }
        
        .rank-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .rank-dist-item {
            background: #3a3a3a;
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
        }
        
        .rank-dist-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d4af37;
        }
        
        .rank-dist-label {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 2rem;
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #d4af37;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #444;
            padding-bottom: 1rem;
        }
        
        .modal-title {
            color: #d4af37;
            font-size: 1.5rem;
            font-family: 'Times New Roman', serif;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #d4af37;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .family-description {
            font-style: italic;
            color: #ccc;
            margin-top: 1rem;
            padding: 1rem;
            background: #3a3a3a;
            border-radius: 4px;
            border-left: 4px solid #d4af37;
        }
        
        .family-stats-modal {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #555;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
        }

        /* NEW STYLES FOR ENHANCED ADMIN FEATURES */
        .admin-controls {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #555;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .control-card {
            background: #2c2c2c;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #444;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .control-card:hover {
            transform: translateY(-3px);
        }

        .control-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .control-title {
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .control-description {
            font-size: 0.8rem;
            color: #ccc;
        }

        .notification-management {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #555;
        }

        .notification-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .broadcast-section {
            background: linear-gradient(135deg, #2c2c2c, #8B0000);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #d4af37;
        }

        .broadcast-title {
            color: #d4af37;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .tribute-management {
            background: linear-gradient(135deg, #2c2c2c, #2e8b57);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #d4af37;
        }

        .tribute-calculator {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .tribute-result {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .admin-notifications {
            max-height: 400px;
            overflow-y: auto;
        }

        .admin-notification-item {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #d4af37;
        }

        .admin-notification-item.unread {
            border-left: 4px solid #8B0000;
            background: #3a3a3a;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 0.5rem;
        }

        .system-health {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #555;
        }

        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .health-stat {
            background: #2c2c2c;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .health-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
        }

        .health-label {
            font-size: 0.8rem;
            color: #ccc;
        }

        .notification-actions {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* USER MANAGEMENT STYLES */
        .user-management-section {
            margin-top: 2rem;
        }

        .search-user {
            margin-bottom: 2rem;
        }

        .user-edit-form {
            display: none;
            background: #2c2c2c;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #444;
            margin-bottom: 2rem;
        }

        .user-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #555;
            transition: transform 0.3s;
        }

        .user-card:hover {
            transform: translateY(-2px);
        }

        .quick-actions {
            margin: 1rem 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-stat-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #555;
        }

        .user-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .user-stat-label {
            font-size: 0.9rem;
            color: #ccc;
        }

        /* RIVALRY MANAGEMENT STYLES */
        .rivalry-management {
            background: linear-gradient(135deg, #2c2c2c, #8B0000);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #d4af37;
        }

        .rivalry-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
        }

        .rivalry-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: #3a3a3a;
            border: 1px solid #444;
            border-bottom: none;
            margin-right: 0.25rem;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            color: #ccc;
        }

        .rivalry-tab.active {
            background: #2c2c2c;
            border-bottom: 1px solid #2c2c2c;
            margin-bottom: -1px;
            font-weight: 500;
            color: #d4af37;
        }

        .rivalry-content {
            display: none;
            padding: 1.5rem;
            background: #2c2c2c;
            border-radius: 0 8px 8px 8px;
            border: 1px solid #444;
            min-height: 500px;
        }

        .rivalry-content.active {
            display: block;
        }

        .war-form, .challenge-form, .territory-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-full-width {
            grid-column: 1 / -1;
        }

        .active-events {
            margin-top: 2rem;
        }

        .event-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .event-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #555;
        }

        .event-card.war {
            border-left: 4px solid #e74c3c;
        }

        .event-card.challenge {
            border-left: 4px solid #9b59b6;
        }

        .event-card.territory {
            border-left: 4px solid #2ecc71;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .event-title {
            font-weight: bold;
            color: #d4af37;
        }

        .event-status {
            background: #d4af37;
            color: #1a1a1a;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .event-details {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 0.5rem;
        }

        .event-timer {
            font-size: 0.8rem;
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: #3a3a3a;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #555;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .quick-action-btn {
            background: #2c2c2c;
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quick-action-btn:hover {
            background: #d4af37;
            color: #1a1a1a;
        }

        .family-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .family-option {
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .family-option.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .family-option:hover {
            border-color: #d4af37;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #555;
        }

        .results-table th {
            background: #3a3a3a;
            color: #d4af37;
            font-weight: bold;
        }

        .results-table tr:hover {
            background: #3a3a3a;
        }

        @media (max-width: 768px) {
            .notification-form {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .tribute-calculator {
                grid-template-columns: 1fr;
            }

            .health-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .notification-actions {
                flex-direction: column;
            }

            .quick-actions {
                flex-direction: column;
            }

            .user-stats {
                grid-template-columns: 1fr;
            }

            .war-form, .challenge-form, .territory-form {
                grid-template-columns: 1fr;
            }

            .family-selector {
                grid-template-columns: 1fr;
            }

            .event-list {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs, .rivalry-tabs {
                flex-direction: column;
            }
            
            .tab, .rivalry-tab {
                margin-right: 0;
                margin-bottom: 0.25rem;
                border-radius: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Login Page -->
    <div id="admin-login-page" class="page active">
        <div class="container">
            <div class="auth-container">
                <h1>Family Operations</h1>
                <h2>Don Login</h2>
                <div id="admin-error-message" class="error-message"></div>
                
                <form id="admin-login-form" class="auth-form">
                    <input type="email" id="admin-email" placeholder="Don Email" required>
                    <input type="password" id="admin-password" placeholder="Don Password" required>
                    <button type="submit">Enter The Office</button>
                </form>
                <button class="btn btn-warning" onclick="window.location.href='index.html'" style="width: 100%;">Back to Family</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="page">
        <header>
            <h1>Family Operations - Don's Office</h1>
            <div>
                <button id="back-to-overview" class="btn back-to-overview">Back to Overview</button>
                <button id="admin-logout-btn" class="btn btn-danger">Go Rogue</button>
            </div>
        </header>
        
        <div class="admin-container">
            <!-- Enhanced Admin Controls -->
            <div class="admin-controls">
                <h2 class="section-title">🏛️ Don's Command Center</h2>
                <div class="controls-grid">
                    <div class="control-card" onclick="generateRankings()">
                        <div class="control-icon">🏆</div>
                        <div class="control-title">Generate Rankings</div>
                        <div class="control-description">Update all family rankings</div>
                    </div>
                    <div class="control-card" onclick="showNotificationModal()">
                        <div class="control-icon">📢</div>
                        <div class="control-title">Send Broadcast</div>
                        <div class="control-description">Message all associates</div>
                    </div>
                    <div class="control-card" onclick="showRivalryManagement()">
                        <div class="control-icon">⚔️</div>
                        <div class="control-title">Manage Rivalries</div>
                        <div class="control-description">Family wars & challenges</div>
                    </div>
                    <div class="control-card" onclick="calculateTributes()">
                        <div class="control-icon">💰</div>
                        <div class="control-title">Calculate Tributes</div>
                        <div class="control-description">Monthly tribute distribution</div>
                    </div>
                    <div class="control-card" onclick="showSystemHealth()">
                        <div class="control-icon">⚙️</div>
                        <div class="control-title">System Health</div>
                        <div class="control-description">Check system status</div>
                    </div>
                </div>
            </div>

            <!-- System Health Dashboard -->
            <div class="system-health" id="system-health-section" style="display: none;">
                <h2 class="section-title">⚙️ System Health & Analytics</h2>
                <div class="health-stats" id="health-stats">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Broadcast Section -->
            <div class="broadcast-section">
                <h2 class="broadcast-title">📢 Family Broadcast System</h2>
                <div class="notification-form">
                    <div class="form-group">
                        <label for="broadcast-title" class="form-label">Broadcast Title</label>
                        <input type="text" id="broadcast-title" class="form-control" placeholder="Important Family Announcement">
                    </div>
                    <div class="form-group">
                        <label for="broadcast-type" class="form-label">Message Type</label>
                        <select id="broadcast-type" class="form-control">
                            <option value="general">General Announcement</option>
                            <option value="family_contract">Family Contract</option>
                            <option value="tribute_distributed">Tribute Update</option>
                            <option value="rank_promotion">Rank Promotion</option>
                            <option value="urgent">Urgent News</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="broadcast-message" class="form-label">Broadcast Message</label>
                        <textarea id="broadcast-message" class="form-control" placeholder="Your important message to all family members..." rows="4"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <button class="btn btn-warning" onclick="sendBroadcast()" style="width: 100%;">🚀 Send Family Broadcast</button>
                    </div>
                </div>
            </div>

            <!-- Tribute Management -->
            <div class="tribute-management">
                <h2 class="section-title">💰 Monthly Tribute Management</h2>
                <div class="tribute-calculator" id="tribute-calculator">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-success" onclick="distributeTributes()">🎁 Distribute Monthly Tributes</button>
                    <button class="btn btn-info" onclick="resetMonthlyRankings()">🔄 Reset Monthly Rankings</button>
                </div>
            </div>

            <!-- Rivalry Management Section -->
            <div class="rivalry-management" id="rivalry-management-section" style="display: none;">
                <h2 class="section-title">⚔️ Family Rivalry Management</h2>
                
                <div class="rivalry-tabs">
                    <div class="rivalry-tab active" data-tab="wars">Family Wars</div>
                    <div class="rivalry-tab" data-tab="challenges">Omertà Challenges</div>
                    <div class="rivalry-tab" data-tab="territories">Territory Control</div>
                    <div class="rivalry-tab" data-tab="weekly-bonuses">Weekly Bonuses</div>
                    <div class="rivalry-tab" data-tab="stats">War Statistics</div>
                </div>

                <!-- Family Wars Tab -->
                <div id="wars-tab" class="rivalry-content active">
                    <h3>Start a Family War</h3>
                    <form id="war-form" class="war-form">
                        <div class="form-group">
                            <label for="war-name" class="form-label">War Name</label>
                            <input type="text" id="war-name" class="form-control" placeholder="The Great Laundry War" required>
                        </div>
                        <div class="form-group">
                            <label for="war-duration" class="form-label">Duration (Days)</label>
                            <select id="war-duration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="3">3 Days</option>
                                <option value="7" selected>7 Days</option>
                                <option value="14">14 Days</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="war-family1" class="form-label">Family 1</label>
                            <select id="war-family1" class="form-control" required>
                                <option value="">Select Family</option>
                                <option value="De Supreme Family">De Supreme Family</option>
                                <option value="De Speed Family">De Speed Family</option>
                                <option value="De Reliable Family">De Reliable Family</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="war-family2" class="form-label">Family 2</label>
                            <select id="war-family2" class="form-control" required>
                                <option value="">Select Family</option>
                                <option value="De Supreme Family">De Supreme Family</option>
                                <option value="De Speed Family">De Speed Family</option>
                                <option value="De Reliable Family">De Reliable Family</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="war-prize" class="form-label">Victory Prize</label>
                            <input type="text" id="war-prize" class="form-control" placeholder="500 Respect Points + Territory Bonus" required>
                        </div>
                        <div class="form-group form-full-width">
                            <label for="war-description" class="form-label">War Description</label>
                            <textarea id="war-description" class="form-control" placeholder="Describe the war objectives and rules..." rows="3"></textarea>
                        </div>
                        <div class="form-group form-full-width">
                            <button type="submit" class="btn btn-danger" style="width: 100%;">⚔️ Declare War</button>
                        </div>
                    </form>

                    <div class="active-events">
                        <h3>Active Family Wars</h3>
                        <div class="event-list" id="active-wars-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Challenges Tab -->
                <div id="challenges-tab" class="rivalry-content">
                    <h3>Create Omertà Challenge</h3>
                    <form id="challenge-form" class="challenge-form">
                        <div class="form-group">
                            <label for="challenge-name" class="form-label">Challenge Name</label>
                            <input type="text" id="challenge-name" class="form-control" placeholder="The Don's Duel" required>
                        </div>
                        <div class="form-group">
                            <label for="challenge-duration" class="form-label">Duration (Days)</label>
                            <select id="challenge-duration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="2">2 Days</option>
                                <option value="3" selected>3 Days</option>
                                <option value="5">5 Days</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="challenger-family" class="form-label">Challenger Family</label>
                            <select id="challenger-family" class="form-control" required>
                                <option value="">Select Family</option>
                                <option value="De Supreme Family">De Supreme Family</option>
                                <option value="De Speed Family">De Speed Family</option>
                                <option value="De Reliable Family">De Reliable Family</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="defender-family" class="form-label">Defender Family</label>
                            <select id="defender-family" class="form-control" required>
                                <option value="">Select Family</option>
                                <option value="De Supreme Family">De Supreme Family</option>
                                <option value="De Speed Family">De Speed Family</option>
                                <option value="De Reliable Family">De Reliable Family</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="challenge-stakes" class="form-label">Stakes</label>
                            <input type="text" id="challenge-stakes" class="form-control" placeholder="Control of Express Machines" required>
                        </div>
                        <div class="form-group">
                            <label for="challenge-prize" class="form-label">Victory Prize</label>
                            <input type="text" id="challenge-prize" class="form-control" placeholder="1000 Respect Points" required>
                        </div>
                        <div class="form-group form-full-width">
                            <label for="challenge-description" class="form-label">Challenge Rules</label>
                            <textarea id="challenge-description" class="form-control" placeholder="Describe the challenge rules and objectives..." rows="3"></textarea>
                        </div>
                        <div class="form-group form-full-width">
                            <button type="submit" class="btn btn-warning" style="width: 100%;">🎯 Create Challenge</button>
                        </div>
                    </form>

                    <div class="active-events">
                        <h3>Active Challenges</h3>
                        <div class="event-list" id="active-challenges-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Territory Control Tab -->
                <div id="territories-tab" class="rivalry-content">
                    <h3>Manage Territories</h3>
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="resetAllTerritories()">
                            🔄 Reset All Territories
                        </div>
                        <div class="quick-action-btn" onclick="assignRandomTerritories()">
                            🎲 Random Assignment
                        </div>
                        <div class="quick-action-btn" onclick="calculateTerritoryBonuses()">
                            💰 Calculate Bonuses
                        </div>
                        <div class="quick-action-btn" onclick="distributeTerritoryRewards()">
                            🎁 Distribute Rewards
                        </div>
                    </div>

                    <form id="territory-form" class="territory-form">
                        <div class="form-group">
                            <label for="territory-select" class="form-label">Territory</label>
                            <select id="territory-select" class="form-control" required>
                                <option value="">Select Territory</option>
                                <option value="express_machines">Express Machines</option>
                                <option value="dry_cleaning">Dry Cleaning Station</option>
                                <option value="folding_area">Folding Area</option>
                                <option value="vip_lounge">VIP Lounge</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="territory-family" class="form-label">Controlling Family</label>
                            <select id="territory-family" class="form-control" required>
                                <option value="">Select Family</option>
                                <option value="De Supreme Family">De Supreme Family</option>
                                <option value="De Speed Family">De Speed Family</option>
                                <option value="De Reliable Family">De Reliable Family</option>
                                <option value="none">Uncontrolled</option>
                            </select>
                        </div>
                        <div class="form-group form-full-width">
                            <button type="submit" class="btn btn-success" style="width: 100%;">🏰 Update Territory</button>
                        </div>
                    </form>

                    <div class="active-events">
                        <h3>Current Territory Control</h3>
                        <div class="event-list" id="territories-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Bonuses Tab -->
                <div id="weekly-bonuses-tab" class="rivalry-content">
                    <h3>💰 Manual Weekly Bonuses</h3>
                    <p>Control bonus distribution based on actual business performance</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="initializeManualBonuses()">
                            🎯 Initialize Bonuses
                        </div>
                        <div class="quick-action-btn" onclick="loadWeeklyBonuses()">
                            🔄 Refresh View
                        </div>
                    </div>

                    <div class="bonus-grid" id="bonus-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="stats-tab" class="rivalry-content">
                    <h3>War & Challenge Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-wars">0</div>
                            <div class="stat-label">Total Wars</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="active-wars-count">0</div>
                            <div class="stat-label">Active Wars</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-challenges">0</div>
                            <div class="stat-label">Total Challenges</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="active-challenges-count">0</div>
                            <div class="stat-label">Active Challenges</div>
                        </div>
                    </div>

                    <h4>Recent War Results</h4>
                    <div class="results-table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>War</th>
                                    <th>Families</th>
                                    <th>Winner</th>
                                    <th>Date</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="war-results-table">
                                <!-- War results will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <h4>Family Performance</h4>
                    <div class="results-table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Family</th>
                                    <th>Wars Won</th>
                                    <th>Challenges Won</th>
                                    <th>Territories</th>
                                    <th>Total Points</th>
                                </tr>
                            </thead>
                            <tbody id="family-performance-table">
                                <!-- Family performance will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="rankings">Family Rankings</div>
                <div class="tab" data-tab="jobs">Jobs Management</div>
                <div class="tab" data-tab="requests">Job Requests</div>
                <div class="tab" data-tab="vault">Vault Requests</div>
                <div class="tab" data-tab="users">User Management</div>
                <div class="tab" data-tab="rivalry">Rivalry Management</div>
                <div class="tab" data-tab="notifications">Admin Notifications</div>
            </div>
            
            <div id="rankings-tab" class="tab-content active">
                <h2 class="section-title">Family Rankings & Hierarchy</h2>
                
                <div style="text-align: center; margin: 1rem 0;">
                    <button class="btn btn-warning" onclick="generateRankings()">Generate Rankings</button>
                    <button class="btn btn-info" onclick="loadRankings()">Refresh Rankings</button>
                    <button class="btn btn-success" onclick="exportRankings()">Export Data</button>
                </div>
                
                <div class="rankings-grid">
                    <div class="ranking-card">
                        <h3 style="color: #d4af37; margin-bottom: 1rem;">Overall Family Rankings</h3>
                        <div class="ranking-list" id="overall-rankings">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-card">
                        <h3 style="color: #d4af37; margin-bottom: 1rem;">Family Territories & Hierarchy</h3>
                        <div class="geographical-map">
                            <div id="families-overview">
                                <div class="loading">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="jobs-tab" class="tab-content">
                <h2 class="section-title">Jobs Management</h2>
                
                <div class="jobs-management">
                    <div>
                        <h3 style="color: #d4af37; margin-bottom: 1rem;">Create New Job</h3>
                        <form id="add-job-form">
                            <div class="form-group">
                                <label for="job-title" class="form-label">Job Title</label>
                                <input type="text" id="job-title" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="job-description" class="form-label">Job Description</label>
                                <textarea id="job-description" class="form-control" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="job-points" class="form-label">Respect Points</label>
                                <input type="number" id="job-points" class="form-control" min="1" value="50" required>
                            </div>

                            <div class="form-group">
                                <label for="job-type" class="form-label">Job Type</label>
                                <select id="job-type" class="form-control" required>
                                    <option value="quick">Quick Job</option>
                                    <option value="available">Available Job</option>
                                    <option value="family_contract">Family Contract</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-success" style="width: 100%;">Create Job</button>
                        </form>
                    </div>
                    
                    <div>
                        <h3 style="color: #d4af37; margin-bottom: 1rem;">Available Jobs</h3>
                        <div class="jobs-list" id="available-jobs-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="requests-tab" class="tab-content">
                <h2 class="section-title">Job Approval Requests</h2>
                
                <div class="job-requests-list" id="job-requests-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <div id="vault-tab" class="tab-content">
                <h2 class="section-title">Vault Requests</h2>
                
                <div class="vault-requests-list" id="vault-requests-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- USER MANAGEMENT TAB -->
            <div id="users-tab" class="tab-content">
                <div class="user-management-section">
                    <h2 class="section-title">👤 User Management</h2>
                    
                    <!-- User Statistics -->
                    <div class="user-stats" id="user-stats">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    
                    <!-- Search User -->
                    <div class="search-user">
                        <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                            <input type="text" id="search-user-input" placeholder="Search by email, name, or phone" 
                                   style="flex: 1; padding: 10px; background: #3a3a3a; border: 1px solid #555; color: white; border-radius: 4px;">
                            <button onclick="searchUser()" class="btn btn-primary">Search User</button>
                        </div>
                    </div>

                    <!-- User Edit Form (Initially Hidden) -->
                    <div id="user-edit-form" class="user-edit-form">
                        <h3>Edit User Details</h3>
                        
                        <div class="vault-form">
                            <div class="form-group">
                                <label class="form-label">User ID</label>
                                <input type="text" id="edit-user-id" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="edit-user-email" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="edit-user-name" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" id="edit-user-phone" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Points Balance</label>
                                <input type="number" id="edit-user-points" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select id="edit-user-role" class="form-control">
                                    <option value="customer">Customer</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Family Assignment</label>
                                <select id="edit-user-family" class="form-control">
                                    <option value="De Supreme Family">De Supreme Family</option>
                                    <option value="De Speed Family">De Speed Family</option>
                                    <option value="De Reliable Family">De Reliable Family</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="edit-user-status" class="form-control">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="grid-column: 1 / -1; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="updateUserDetails()" class="btn btn-success" style="flex: 1;">Update User</button>
                                <button onclick="resetPassword()" class="btn btn-warning">Reset Password</button>
                                <button onclick="deleteUser()" class="btn btn-danger">Delete User</button>
                                <button onclick="closeUserEdit()" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button onclick="loadAllUsers()" class="btn btn-info">Load All Users</button>
                        <button onclick="exportUserData()" class="btn btn-warning">Export User Data</button>
                        <button onclick="generateMigrationReportForAll()" class="btn btn-danger">Migration Report</button>
                    </div>

                    <!-- Users List -->
                    <div id="users-list-container">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIVALRY MANAGEMENT TAB -->
            <div id="rivalry-tab" class="tab-content">
                <h2 class="section-title">⚔️ Rivalry Management</h2>
                <div class="quick-actions">
                    <div class="quick-action-btn" onclick="showRivalryManagement()">
                        ⚔️ Manage Rivalries
                    </div>
                    <div class="quick-action-btn" onclick="loadActiveWars()">
                        🔥 Active Wars
                    </div>
                    <div class="quick-action-btn" onclick="loadActiveChallenges()">
                        🎯 Active Challenges
                    </div>
                    <div class="quick-action-btn" onclick="loadTerritories()">
                        🏰 Territories
                    </div>
                </div>
                <div id="rivalry-content">
                    <div class="empty-state">
                        <div>⚔️</div>
                        <p>Rivalry Management System</p>
                        <p>Click "Manage Rivalries" to access the full rivalry management interface</p>
                    </div>
                </div>
            </div>

            <div id="notifications-tab" class="tab-content">
                <h2 class="section-title">📋 Admin Notification Center</h2>
                <div class="notification-actions">
                    <button class="btn btn-info" onclick="loadAdminNotifications()">Refresh Notifications</button>
                    <button class="btn btn-warning" onclick="markAllAdminNotificationsRead()">Mark All as Read</button>
                    <button class="btn btn-danger" onclick="clearOldNotifications()">Clear Old Notifications</button>
                </div>
                <div class="admin-notifications" id="admin-notifications-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Family Modal -->
    <div id="family-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-family-name">Family Details</h3>
                <button class="close-modal" onclick="closeFamilyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="family-stats-modal" id="modal-family-stats">
                    <!-- Stats will be populated here -->
                </div>
                <div class="family-description" id="modal-family-description">
                    <!-- Description will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeFamilyModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Leading Family Modal -->
    <div id="leading-family-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="leading-family-name">Leading Family</h3>
                <button class="close-modal" onclick="closeLeadingFamilyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="family-stats-modal" id="leading-family-stats">
                    <!-- Stats will be populated here -->
                </div>
                <div class="rank-distribution" id="rank-distribution">
                    <!-- Rank distribution will be populated here -->
                </div>
                <div class="family-description" id="leading-family-description">
                    <!-- Description will be populated here -->
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #3a3a3a; border-radius: 8px; border-left: 4px solid #d4af37;">
                    <h4 style="color: #d4af37; margin-bottom: 0.5rem;">👑 The Don</h4>
                    <p id="leading-family-don">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeLeadingFamilyModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Send Notification</h3>
                <button class="close-modal" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="notification-user" class="form-label">Send To</label>
                    <select id="notification-user" class="form-control">
                        <option value="all">All Users</option>
                        <option value="specific">Specific User</option>
                    </select>
                </div>
                <div class="form-group" id="specific-user-group" style="display: none;">
                    <label for="specific-user-email" class="form-label">User Email</label>
                    <input type="email" id="specific-user-email" class="form-control" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label for="notification-title" class="form-label">Title</label>
                    <input type="text" id="notification-title" class="form-control" placeholder="Notification Title">
                </div>
                <div class="form-group">
                    <label for="notification-message" class="form-label">Message</label>
                    <textarea id="notification-message" class="form-control" placeholder="Your message..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="notification-type" class="form-label">Type</label>
                    <select id="notification-type" class="form-control">
                        <option value="general">General</option>
                        <option value="job_approved">Job Approved</option>
                        <option value="job_rejected">Job Rejected</option>
                        <option value="family_contract">Family Contract</option>
                        <option value="tribute_distributed">Tribute Distributed</option>
                        <option value="rank_promotion">Rank Promotion</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeNotificationModal()">Cancel</button>
                <button class="btn btn-success" onclick="sendCustomNotification()">Send Notification</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading-indicator">
        <div class="spinner"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC-UKRcGQ6k_UekiBigQLmU9WR20UGazWg",
            authDomain: "desupreme-laundromat-store-mgt.firebaseapp.com",
            databaseURL: "https://desupreme-laundromat-store-mgt-default-rtdb.firebaseio.com",
            projectId: "desupreme-laundromat-store-mgt",
            storageBucket: "desupreme-laundromat-store-mgt.appspot.com",
            messagingSenderId: "635010254043",
            appId: "1:635010254043:web:81addf7247e261c8a538fe",
            measurementId: "G-0YDT6GEWZS"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const database = firebase.database();
        
        // Family system from customer dashboard
        const families = [
            "De Supreme Family", 
            "De Speed Family", 
            "De Reliable Family"
        ];
        
        const familyDescriptions = {
            "De Supreme Family": "Join the family that sets the standard. We don't follow trends - we create them. Excellence flows through our veins.",
            "De Speed Family": "Time is money, and we respect both. Join the family that gets things done while others are still talking.",
            "De Reliable Family": "In this world, you need people you can count on. We're the foundation everything else is built upon."
        };

        // Territory System Configuration
        const territoriesConfig = {
            'express_machines': { name: 'Express Machines', bonus: 'Double points on express washes', value: 2.0, points: 200 },
            'dry_cleaning': { name: 'Dry Cleaning Station', bonus: '+25% points on dry cleaning', value: 1.25, points: 125 },
            'folding_area': { name: 'Folding Area', bonus: 'Bonus points for folding services', value: 1.5, points: 150 },
            'vip_lounge': { name: 'VIP Lounge', bonus: 'Exclusive VIP job access', value: 3.0, points: 300 }
        };
        
        let currentAdminUser = null;
        let familyStats = {};
        let leadingFamily = null;

        // Security rule compatible functions
        function hasAdminAccess() {
            return currentAdminUser && currentAdminUser.role === 'admin';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        // Geographical location function from customer dashboard
        function getGeographicalLocation(email) {
            const emailHash = email.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const familyIndex = Math.abs(emailHash) % families.length;
            return families[familyIndex];
        }

        // Modal functions from customer dashboard
        function showFamilyModal(familyName) {
            const modal = document.getElementById('family-modal');
            const modalTitle = document.getElementById('modal-family-name');
            const modalStats = document.getElementById('modal-family-stats');
            const modalDescription = document.getElementById('modal-family-description');
            
            modalTitle.textContent = familyName;
            
            const stats = familyStats[familyName];
            
            modalStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.members}</div>
                    <div class="stat-label">Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalRespect}</div>
                    <div class="stat-label">Total Respect</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgRespect}</div>
                    <div class="stat-label">Average Respect</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.highestRespect}</div>
                    <div class="stat-label">Highest Respect</div>
                </div>
            `;
            
            modalDescription.textContent = familyDescriptions[familyName];
            modal.style.display = 'flex';
        }
        
        function showLeadingFamilyModal() {
            if (!leadingFamily) return;
            
            const modal = document.getElementById('leading-family-modal');
            const modalTitle = document.getElementById('leading-family-name');
            const modalStats = document.getElementById('leading-family-stats');
            const rankDistribution = document.getElementById('rank-distribution');
            const modalDescription = document.getElementById('leading-family-description');
            const donInfo = document.getElementById('leading-family-don');
            
            modalTitle.textContent = leadingFamily;
            
            const stats = familyStats[leadingFamily];
            
            modalStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.members}</div>
                    <div class="stat-label">Total Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalRespect}</div>
                    <div class="stat-label">Total Respect</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgRespect}</div>
                    <div class="stat-label">Average Respect</div>
                </div>
            `;
            
            // Create rank distribution
            rankDistribution.innerHTML = '';
            Object.entries(stats.rankDistribution).forEach(([rank, count]) => {
                if (count > 0) {
                    rankDistribution.innerHTML += `
                        <div class="rank-dist-item">
                            <div class="rank-dist-count">${count}</div>
                            <div class="rank-dist-label">${rank.charAt(0).toUpperCase() + rank.slice(1)}</div>
                        </div>
                    `;
                }
            });
            
            modalDescription.textContent = familyDescriptions[leadingFamily];
            donInfo.textContent = `${stats.highestMember} - ${stats.highestRespect} Respect`;
            
            modal.style.display = 'flex';
        }
        
        function closeFamilyModal() {
            document.getElementById('family-modal').style.display = 'none';
        }
        
        function closeLeadingFamilyModal() {
            document.getElementById('leading-family-modal').style.display = 'none';
        }

        // NEW: Notification Modal Functions
        function showNotificationModal() {
            document.getElementById('notification-modal').style.display = 'flex';
        }

        function closeNotificationModal() {
            document.getElementById('notification-modal').style.display = 'none';
        }

        // NEW: Send Custom Notification
        function sendCustomNotification() {
            const userType = document.getElementById('notification-user').value;
            const specificEmail = document.getElementById('specific-user-email').value;
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            const type = document.getElementById('notification-type').value;

            if (!title || !message) {
                alert('Please fill in title and message');
                return;
            }

            showLoading();

            if (userType === 'all') {
                // Send to all users
                database.ref('users').once('value')
                    .then((snapshot) => {
                        const promises = [];
                        snapshot.forEach(userSnapshot => {
                            const userData = userSnapshot.val();
                            if (userData.role === 'customer') {
                                const notificationId = 'admin_notification_' + Date.now();
                                const notificationData = {
                                    userId: userSnapshot.key,
                                    userEmail: userData.email,
                                    type: type,
                                    title: title,
                                    message: message,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    read: false,
                                    fromAdmin: true,
                                    adminEmail: currentAdminUser.email
                                };
                                promises.push(
                                    database.ref('notifications/' + userSnapshot.key + '/' + notificationId).set(notificationData)
                                );
                            }
                        });
                        return Promise.all(promises);
                    })
                    .then(() => {
                        hideLoading();
                        alert('Notification sent to all users!');
                        closeNotificationModal();
                        // Create admin notification for record
                        createAdminNotification(`Broadcast sent to all users: "${title}"`, 'broadcast_sent');
                    })
                    .catch((error) => {
                        hideLoading();
                        alert('Error sending notification: ' + error.message);
                    });
            } else {
                // Send to specific user
                if (!specificEmail) {
                    alert('Please enter a user email');
                    hideLoading();
                    return;
                }

                database.ref('users').orderByChild('email').equalTo(specificEmail).once('value')
                    .then((snapshot) => {
                        if (!snapshot.exists()) {
                            throw new Error('User not found');
                        }
                        let userId = '';
                        snapshot.forEach(userSnapshot => {
                            userId = userSnapshot.key;
                        });
                        const notificationId = 'admin_notification_' + Date.now();
                        const notificationData = {
                            userId: userId,
                            userEmail: specificEmail,
                            type: type,
                            title: title,
                            message: message,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            read: false,
                            fromAdmin: true,
                            adminEmail: currentAdminUser.email
                        };
                        return database.ref('notifications/' + userId + '/' + notificationId).set(notificationData);
                    })
                    .then(() => {
                        hideLoading();
                        alert(`Notification sent to ${specificEmail}!`);
                        closeNotificationModal();
                        createAdminNotification(`Notification sent to ${specificEmail}: "${title}"`, 'user_notification_sent');
                    })
                    .catch((error) => {
                        hideLoading();
                        alert('Error sending notification: ' + error.message);
                    });
            }
        }

        // NEW: Create Admin Notification
        function createAdminNotification(message, type = 'system') {
            const notificationId = 'admin_log_' + Date.now();
            const notificationData = {
                message: message,
                type: type,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false,
                adminId: currentAdminUser.uid
            };
            database.ref('adminNotifications/' + notificationId).set(notificationData);
        }

        // NEW: Load Admin Notifications
        function loadAdminNotifications() {
            const notificationsList = document.getElementById('admin-notifications-list');
            notificationsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            database.ref('adminNotifications').orderByChild('timestamp').once('value')
                .then((snapshot) => {
                    notificationsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        notificationsList.innerHTML = '<div class="empty-state"><div>📭</div><p>No admin notifications yet</p></div>';
                        return;
                    }

                    const notifications = [];
                    snapshot.forEach(notificationSnapshot => {
                        const notification = notificationSnapshot.val();
                        notification.id = notificationSnapshot.key;
                        notifications.push(notification);
                    });

                    notifications.sort((a, b) => b.timestamp - a.timestamp);

                    if (notifications.length === 0) {
                        notificationsList.innerHTML = '<div class="empty-state"><div>📭</div><p>No admin notifications yet</p></div>';
                        return;
                    }

                    notifications.forEach(notification => {
                        const notificationItem = document.createElement('div');
                        notificationItem.className = `admin-notification-item ${notification.read ? '' : 'unread'}`;
                        
                        const date = new Date(notification.timestamp).toLocaleString();
                        const typeColor = getNotificationColor(notification.type);
                        
                        notificationItem.innerHTML = `
                            <div style="border-left: 4px solid ${typeColor}; padding-left: 1rem;">
                                <div style="font-weight: bold; color: #d4af37; margin-bottom: 0.5rem;">${notification.message}</div>
                                <div class="notification-meta">
                                    <span style="background: ${typeColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                        ${notification.type.replace('_', ' ').toUpperCase()}
                                    </span>
                                    <span>${date}</span>
                                </div>
                            </div>
                        `;
                        
                        notificationsList.appendChild(notificationItem);
                    });
                })
                .catch((error) => {
                    console.error('Error loading admin notifications:', error);
                    notificationsList.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading notifications</p></div>';
                });
        }

        // NEW: Mark all admin notifications as read
        function markAllAdminNotificationsRead() {
            showLoading();
            
            database.ref('adminNotifications').once('value')
                .then((snapshot) => {
                    const updates = {};
                    
                    snapshot.forEach(notificationSnapshot => {
                        const notification = notificationSnapshot.val();
                        if (!notification.read) {
                            updates['adminNotifications/' + notificationSnapshot.key + '/read'] = true;
                        }
                    });
                    
                    if (Object.keys(updates).length === 0) {
                        hideLoading();
                        alert('All notifications are already read!');
                        return;
                    }
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    hideLoading();
                    alert('All admin notifications marked as read!');
                    loadAdminNotifications();
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Error marking admin notifications as read:', error);
                    alert('Error: ' + error.message);
                });
        }

        // NEW: Clear old notifications
        function clearOldNotifications() {
            if (!confirm('Clear notifications older than 30 days?')) return;
            
            showLoading();
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            
            database.ref('adminNotifications').once('value')
                .then((snapshot) => {
                    const updates = {};
                    let clearedCount = 0;
                    
                    snapshot.forEach(notificationSnapshot => {
                        const notification = notificationSnapshot.val();
                        if (notification.timestamp < thirtyDaysAgo) {
                            updates['adminNotifications/' + notificationSnapshot.key] = null;
                            clearedCount++;
                        }
                    });
                    
                    if (clearedCount === 0) {
                        hideLoading();
                        alert('No old notifications to clear!');
                        return;
                    }
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    hideLoading();
                    alert('Old notifications cleared successfully!');
                    loadAdminNotifications();
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Error clearing old notifications:', error);
                    alert('Error: ' + error.message);
                });
        }

        // NEW: Send Broadcast to all users
        function sendBroadcast() {
            const title = document.getElementById('broadcast-title').value;
            const message = document.getElementById('broadcast-message').value;
            const type = document.getElementById('broadcast-type').value;

            if (!title || !message) {
                alert('Please fill in title and message');
                return;
            }

            showLoading();

            database.ref('users').once('value')
                .then((snapshot) => {
                    const promises = [];
                    let userCount = 0;
                    
                    snapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        if (userData.role === 'customer') {
                            userCount++;
                            const notificationId = 'broadcast_' + Date.now() + '_' + userCount;
                            const notificationData = {
                                userId: userSnapshot.key,
                                userEmail: userData.email,
                                type: type,
                                title: title,
                                message: message,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                read: false,
                                fromAdmin: true,
                                adminEmail: currentAdminUser.email,
                                isBroadcast: true
                            };
                            promises.push(
                                database.ref('notifications/' + userSnapshot.key + '/' + notificationId).set(notificationData)
                            );
                        }
                    });
                    
                    return Promise.all(promises).then(() => userCount);
                })
                .then((userCount) => {
                    hideLoading();
                    alert(`📢 Broadcast sent to ${userCount} users!`);
                    // Clear form
                    document.getElementById('broadcast-title').value = '';
                    document.getElementById('broadcast-message').value = '';
                    // Create admin notification
                    createAdminNotification(`Broadcast sent to ${userCount} users: "${title}"`, 'broadcast_sent');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error sending broadcast: ' + error.message);
                });
        }

        // NEW: Calculate Tributes
        function calculateTributes() {
            showLoading();
            
            database.ref('rankings').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        hideLoading();
                        alert('No rankings data available');
                        return;
                    }

                    const tributeCalculator = document.getElementById('tribute-calculator');
                    let html = '';

                    families.forEach(family => {
                        const familyMembers = [];
                        let familyTotalRespect = 0;
                        
                        snapshot.forEach(rankSnapshot => {
                            const rankData = rankSnapshot.val();
                            if (getGeographicalLocation(rankData.email) === family) {
                                familyMembers.push(rankData);
                                familyTotalRespect += rankData.points;
                            }
                        });

                        if (familyMembers.length > 0) {
                            familyMembers.sort((a, b) => b.points - a.points);
                            
                            const donTribute = Math.floor(familyTotalRespect * 0.10);
                            const underbossTribute = Math.floor(familyTotalRespect * 0.05);
                            const capoCount = Math.max(1, Math.floor(familyMembers.length * 0.1));
                            const capoTribute = Math.floor(familyTotalRespect * 0.02) * capoCount;
                            const totalTributes = donTribute + underbossTribute + capoTribute;

                            html += `
                                <div class="tribute-result">
                                    <div style="font-weight: bold; color: #d4af37; margin-bottom: 0.5rem;">${family}</div>
                                    <div style="font-size: 0.9rem;">
                                        <div>Don: ${donTribute} Respect</div>
                                        <div>Underboss: ${underbossTribute} Respect</div>
                                        <div>Capos: ${capoTribute} Respect</div>
                                        <div style="margin-top: 0.5rem; font-weight: bold;">Total: ${totalTributes} Respect</div>
                                    </div>
                                </div>
                            `;
                        }
                    });

                    tributeCalculator.innerHTML = html;
                    hideLoading();
                    createAdminNotification('Tribute calculation performed', 'tribute_calculated');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error calculating tributes: ' + error.message);
                });
        }

        // NEW: Distribute Tributes
        function distributeTributes() {
            if (!confirm('Distribute monthly tributes? This will award points to family leaders.')) return;
            
            showLoading();
            
            database.ref('rankings').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        throw new Error('No rankings data available');
                    }

                    const updates = {};
                    const notificationPromises = [];
                    let totalDistributed = 0;
                    let recipientCount = 0;

                    families.forEach(family => {
                        const familyMembers = [];
                        let familyTotalRespect = 0;
                        
                        snapshot.forEach(rankSnapshot => {
                            const rankData = rankSnapshot.val();
                            if (getGeographicalLocation(rankData.email) === family) {
                                familyMembers.push({...rankData, id: rankSnapshot.key});
                                familyTotalRespect += rankData.points;
                            }
                        });

                        if (familyMembers.length > 0) {
                            familyMembers.sort((a, b) => b.points - a.points);
                            
                            // Don gets 10%
                            if (familyMembers[0]) {
                                const donTribute = Math.floor(familyTotalRespect * 0.10);
                                const pointsHistoryId = 'tribute_' + Date.now() + '_don';
                                updates['pointsHistory/' + pointsHistoryId] = {
                                    pointsAdded: donTribute,
                                    reason: `Monthly Tribute as Don of ${family}`,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    addedBy: 'System (Tribute Distribution)',
                                    customerEmail: familyMembers[0].email,
                                    customerId: familyMembers[0].userId,
                                    isTribute: true,
                                    family: family,
                                    role: 'don'
                                };
                                
                                // Send notification to Don
                                const notificationId = 'tribute_' + Date.now();
                                notificationPromises.push(
                                    database.ref('notifications/' + familyMembers[0].userId + '/' + notificationId).set({
                                        userId: familyMembers[0].userId,
                                        userEmail: familyMembers[0].email,
                                        type: 'tribute_distributed',
                                        title: '💰 Tribute Received!',
                                        message: `You received ${donTribute} Respect as Don of ${family}`,
                                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                                        read: false
                                    })
                                );
                                
                                totalDistributed += donTribute;
                                recipientCount++;
                            }

                            // Underboss gets 5%
                            if (familyMembers[1]) {
                                const underbossTribute = Math.floor(familyTotalRespect * 0.05);
                                const pointsHistoryId = 'tribute_' + Date.now() + '_underboss';
                                updates['pointsHistory/' + pointsHistoryId] = {
                                    pointsAdded: underbossTribute,
                                    reason: `Monthly Tribute as Underboss of ${family}`,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    addedBy: 'System (Tribute Distribution)',
                                    customerEmail: familyMembers[1].email,
                                    customerId: familyMembers[1].userId,
                                    isTribute: true,
                                    family: family,
                                    role: 'underboss'
                                };
                                
                                totalDistributed += underbossTribute;
                                recipientCount++;
                            }
                        }
                    });

                    return database.ref().update(updates)
                        .then(() => Promise.all(notificationPromises))
                        .then(() => ({ totalDistributed, recipientCount }));
                })
                .then(({ totalDistributed, recipientCount }) => {
                    hideLoading();
                    alert(`✅ Tributes distributed! ${totalDistributed} Respect given to ${recipientCount} family leaders.`);
                    createAdminNotification(`Tributes distributed: ${totalDistributed} Respect to ${recipientCount} leaders`, 'tribute_distributed');
                    // Regenerate rankings to reflect new points
                    generateRankings();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error distributing tributes: ' + error.message);
                });
        }

        // NEW: Reset Monthly Rankings
        function resetMonthlyRankings() {
            if (!confirm('Reset monthly rankings? This will archive current data and start fresh.')) return;
            
            showLoading();
            
            // In a real implementation, this would:
            // 1. Archive current rankings
            // 2. Reset monthly points while keeping lifetime totals
            // 3. Notify all users
            
            setTimeout(() => {
                hideLoading();
                alert('Monthly rankings reset feature would be implemented here');
                createAdminNotification('Monthly rankings reset initiated', 'system_maintenance');
            }, 2000);
        }

        // NEW: Show System Health
        function showSystemHealth() {
            const healthSection = document.getElementById('system-health-section');
            const healthStats = document.getElementById('health-stats');
            
            healthSection.style.display = 'block';
            healthStats.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            showLoading();
            
            Promise.all([
                database.ref('users').once('value'),
                database.ref('rankings').once('value'),
                database.ref('jobRequests').once('value'),
                database.ref('vaultRequests').once('value'),
                database.ref('availableJobs').once('value')
            ])
            .then(([usersSnapshot, rankingsSnapshot, jobRequestsSnapshot, vaultRequestsSnapshot, jobsSnapshot]) => {
                const totalUsers = usersSnapshot.numChildren();
                const totalRankings = rankingsSnapshot.numChildren();
                const pendingJobs = jobRequestsSnapshot.numChildren();
                const pendingVault = vaultRequestsSnapshot.numChildren();
                const availableJobs = jobsSnapshot.numChildren();
                
                const customerUsers = [];
                usersSnapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    if (userData.role === 'customer') {
                        customerUsers.push(userData);
                    }
                });
                
                healthStats.innerHTML = `
                    <div class="health-stat">
                        <div class="health-value">${totalUsers}</div>
                        <div class="health-label">Total Users</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-value">${customerUsers.length}</div>
                        <div class="health-label">Customers</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-value">${totalRankings}</div>
                        <div class="health-label">Ranked Users</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-value">${pendingJobs}</div>
                        <div class="health-label">Pending Jobs</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-value">${pendingVault}</div>
                        <div class="health-label">Vault Requests</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-value">${availableJobs}</div>
                        <div class="health-label">Available Jobs</div>
                    </div>
                `;
                
                hideLoading();
                createAdminNotification('System health check performed', 'system_health');
            })
            .catch((error) => {
                hideLoading();
                healthStats.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading system health</p></div>';
            });
        }

        // NEW: Export Rankings Data
        function exportRankings() {
            showLoading();
            
            database.ref('rankings').once('value')
                .then((snapshot) => {
                    const rankings = [];
                    snapshot.forEach(rankSnapshot => {
                        rankings.push(rankSnapshot.val());
                    });
                    
                    // Create CSV content
                    let csv = 'Rank,Name,Email,Points,Family,Phone\n';
                    rankings.forEach(rank => {
                        const family = getGeographicalLocation(rank.email);
                        csv += `"${rank.rank}","${rank.name}","${rank.email}","${rank.points}","${family}","${rank.phone || 'N/A'}"\n`;
                    });
                    
                    // Create download link
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `family_rankings_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    hideLoading();
                    createAdminNotification('Rankings data exported to CSV', 'data_export');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error exporting data: ' + error.message);
                });
        }

        // Get Notification Color
        function getNotificationColor(type) {
            const colors = {
                'job_approved': '#2ecc71',
                'job_rejected': '#e74c3c',
                'general': '#d4af37',
                'family_contract': '#9b59b6',
                'tribute_distributed': '#f39c12',
                'rank_promotion': '#3498db',
                'broadcast_sent': '#8e44ad',
                'user_notification_sent': '#34495e',
                'tribute_calculated': '#16a085',
                'system_health': '#7f8c8d',
                'system_maintenance': '#e67e22',
                'data_export': '#27ae60',
                'urgent': '#c0392b'
            };
            return colors[type] || '#d4af37';
        }

        // ========== RIVALRY MANAGEMENT FUNCTIONS ==========

        // Show Rivalry Management Section
        function showRivalryManagement() {
            document.getElementById('rivalry-management-section').style.display = 'block';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector('[data-tab="rivalry"]').classList.add('active');
            document.getElementById('rivalry-tab').classList.add('active');
            
            loadActiveWars();
            loadActiveChallenges();
            loadTerritories();
            loadWarStatistics();
        }

        // Start a Family War
        document.getElementById('war-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const warName = document.getElementById('war-name').value;
            const duration = parseInt(document.getElementById('war-duration').value);
            const family1 = document.getElementById('war-family1').value;
            const family2 = document.getElementById('war-family2').value;
            const prize = document.getElementById('war-prize').value;
            const description = document.getElementById('war-description').value;

            if (family1 === family2) {
                alert('Please select two different families for the war!');
                return;
            }

            showLoading();

            const warId = 'war_' + Date.now();
            const startTime = Date.now();
            const endTime = startTime + (duration * 24 * 60 * 60 * 1000);

            const warData = {
                id: warId,
                name: warName,
                family1: family1,
                family2: family2,
                startTime: startTime,
                endTime: endTime,
                duration: duration,
                prize: prize,
                description: description,
                status: 'active',
                type: 'war',
                score1: 0,
                score2: 0,
                participants: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref('familyEvents/' + warId).set(warData)
                .then(() => {
                    // Send notifications to both families
                    sendWarNotification(family1, family2, warName, 'declared');
                    sendWarNotification(family2, family1, warName, 'declared');
                    
                    hideLoading();
                    alert(`⚔️ War declared between ${family1} and ${family2}!`);
                    document.getElementById('war-form').reset();
                    loadActiveWars();
                    createAdminNotification(`War declared: ${warName} between ${family1} and ${family2}`, 'war_declared');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error declaring war: ' + error.message);
                });
        });

        // Create Omertà Challenge
        document.getElementById('challenge-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const challengeName = document.getElementById('challenge-name').value;
            const duration = parseInt(document.getElementById('challenge-duration').value);
            const challengerFamily = document.getElementById('challenger-family').value;
            const defenderFamily = document.getElementById('defender-family').value;
            const stakes = document.getElementById('challenge-stakes').value;
            const prize = document.getElementById('challenge-prize').value;
            const description = document.getElementById('challenge-description').value;

            if (challengerFamily === defenderFamily) {
                alert('Challenger and Defender must be different families!');
                return;
            }

            showLoading();

            const challengeId = 'challenge_' + Date.now();
            const startTime = Date.now();
            const endTime = startTime + (duration * 24 * 60 * 60 * 1000);

            const challengeData = {
                id: challengeId,
                name: challengeName,
                challengerFamily: challengerFamily,
                defenderFamily: defenderFamily,
                startTime: startTime,
                endTime: endTime,
                duration: duration,
                stakes: stakes,
                prize: prize,
                description: description,
                status: 'active',
                type: 'challenge',
                challengerPoints: 0,
                defenderPoints: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref('challenges/' + challengeId).set(challengeData)
                .then(() => {
                    // Send notifications to both families
                    sendChallengeNotification(challengerFamily, defenderFamily, challengeName, 'challenged');
                    sendChallengeNotification(defenderFamily, challengerFamily, challengeName, 'accepted');
                    
                    hideLoading();
                    alert(`🎯 Omertà Challenge created: ${challengeName}!`);
                    document.getElementById('challenge-form').reset();
                    loadActiveChallenges();
                    createAdminNotification(`Challenge created: ${challengeName} between ${challengerFamily} and ${defenderFamily}`, 'challenge_created');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error creating challenge: ' + error.message);
                });
        });

        // Update Territory Control
        document.getElementById('territory-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const territoryId = document.getElementById('territory-select').value;
            const familyName = document.getElementById('territory-family').value;

            if (!territoryId) {
                alert('Please select a territory!');
                return;
            }

            showLoading();

            const territoryData = {
                controlledBy: familyName === 'none' ? null : familyName,
                controlledSince: familyName === 'none' ? null : Date.now(),
                familyName: familyName === 'none' ? null : familyName,
                currentBonus: territoriesConfig[territoryId].value,
                lastDistribution: null
            };

            database.ref('territories/' + territoryId).set(territoryData)
                .then(() => {
                    hideLoading();
                    alert(`🏰 Territory ${territoriesConfig[territoryId].name} updated!`);
                    document.getElementById('territory-form').reset();
                    loadTerritories();
                    
                    if (familyName !== 'none') {
                        createAdminNotification(`Territory ${territoriesConfig[territoryId].name} assigned to ${familyName}`, 'territory_assigned');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error updating territory: ' + error.message);
                });
        });

        // Load Active Wars
        function loadActiveWars() {
            const warsList = document.getElementById('active-wars-list');
            warsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            database.ref('familyEvents').orderByChild('type').equalTo('war').once('value')
                .then((snapshot) => {
                    warsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        warsList.innerHTML = '<div class="empty-state"><div>⚔️</div><p>No active wars</p></div>';
                        return;
                    }

                    const wars = [];
                    const now = Date.now();

                    snapshot.forEach(warSnapshot => {
                        const war = warSnapshot.val();
                        war.id = warSnapshot.key;
                        
                        // Check if war is still active
                        if (war.endTime > now && war.status === 'active') {
                            wars.push(war);
                        } else if (war.status === 'active') {
                            // Auto-complete expired wars
                            completeWar(war);
                        }
                    });

                    if (wars.length === 0) {
                        warsList.innerHTML = '<div class="empty-state"><div>⚔️</div><p>No active wars</p></div>';
                        return;
                    }

                    wars.forEach(war => {
                        const timeLeft = war.endTime - now;
                        const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                        const warCard = document.createElement('div');
                        warCard.className = 'event-card war';
                        warCard.innerHTML = `
                            <div class="event-header">
                                <div class="event-title">${war.name}</div>
                                <div class="event-status">ACTIVE</div>
                            </div>
                            <div class="event-details">
                                <strong>${war.family1}</strong> vs <strong>${war.family2}</strong>
                            </div>
                            <div class="event-details">
                                Prize: ${war.prize}
                            </div>
                            <div class="event-details">
                                Score: ${war.family1} - ${war.score1} | ${war.family2} - ${war.score2}
                            </div>
                            <div class="event-timer">
                                ${daysLeft}d ${hoursLeft}h remaining
                            </div>
                            <div class="event-actions">
                                <button class="btn btn-info" onclick="updateWarScore('${war.id}', '${war.family1}')">+1 ${war.family1}</button>
                                <button class="btn btn-info" onclick="updateWarScore('${war.id}', '${war.family2}')">+1 ${war.family2}</button>
                                <button class="btn btn-warning" onclick="endWar('${war.id}')">End War</button>
                                <button class="btn btn-danger" onclick="cancelWar('${war.id}')">Cancel</button>
                            </div>
                        `;
                        warsList.appendChild(warCard);
                    });
                })
                .catch((error) => {
                    console.error('Error loading wars:', error);
                    warsList.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading wars</p></div>';
                });
        }

        // Load Active Challenges
        function loadActiveChallenges() {
            const challengesList = document.getElementById('active-challenges-list');
            challengesList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            database.ref('challenges').orderByChild('status').equalTo('active').once('value')
                .then((snapshot) => {
                    challengesList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        challengesList.innerHTML = '<div class="empty-state"><div>🎯</div><p>No active challenges</p></div>';
                        return;
                    }

                    const challenges = [];
                    const now = Date.now();

                    snapshot.forEach(challengeSnapshot => {
                        const challenge = challengeSnapshot.val();
                        challenge.id = challengeSnapshot.key;
                        
                        // Check if challenge is still active
                        if (challenge.endTime > now) {
                            challenges.push(challenge);
                        } else {
                            // Auto-complete expired challenges
                            completeChallenge(challenge);
                        }
                    });

                    if (challenges.length === 0) {
                        challengesList.innerHTML = '<div class="empty-state"><div>🎯</div><p>No active challenges</p></div>';
                        return;
                    }

                    challenges.forEach(challenge => {
                        const timeLeft = challenge.endTime - now;
                        const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                        const challengeCard = document.createElement('div');
                        challengeCard.className = 'event-card challenge';
                        challengeCard.innerHTML = `
                            <div class="event-header">
                                <div class="event-title">${challenge.name}</div>
                                <div class="event-status">ACTIVE</div>
                            </div>
                            <div class="event-details">
                                <strong>${challenge.challengerFamily}</strong> vs <strong>${challenge.defenderFamily}</strong>
                            </div>
                            <div class="event-details">
                                Stakes: ${challenge.stakes}
                            </div>
                            <div class="event-details">
                                Prize: ${challenge.prize}
                            </div>
                            <div class="event-details">
                                Score: ${challenge.challengerFamily} - ${challenge.challengerPoints} | ${challenge.defenderFamily} - ${challenge.defenderPoints}
                            </div>
                            <div class="event-timer">
                                ${daysLeft}d ${hoursLeft}h remaining
                            </div>
                            <div class="event-actions">
                                <button class="btn btn-info" onclick="updateChallengeScore('${challenge.id}', 'challenger')">+1 ${challenge.challengerFamily}</button>
                                <button class="btn btn-info" onclick="updateChallengeScore('${challenge.id}', 'defender')">+1 ${challenge.defenderFamily}</button>
                                <button class="btn btn-warning" onclick="endChallenge('${challenge.id}')">End Challenge</button>
                                <button class="btn btn-danger" onclick="cancelChallenge('${challenge.id}')">Cancel</button>
                            </div>
                        `;
                        challengesList.appendChild(challengeCard);
                    });
                })
                .catch((error) => {
                    console.error('Error loading challenges:', error);
                    challengesList.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading challenges</p></div>';
                });
        }

        // Load Territories
        function loadTerritories() {
            const territoriesList = document.getElementById('territories-list');
            territoriesList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            database.ref('territories').once('value')
                .then((snapshot) => {
                    territoriesList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        // Initialize territories
                        initializeTerritories();
                        return;
                    }

                    const territories = snapshot.val();

                    Object.keys(territoriesConfig).forEach(territoryId => {
                        const territory = territories[territoryId] || {
                            controlledBy: null,
                            familyName: null
                        };
                        const territoryInfo = territoriesConfig[territoryId];

                        const territoryCard = document.createElement('div');
                        territoryCard.className = 'event-card territory';
                        territoryCard.innerHTML = `
                            <div class="event-header">
                                <div class="event-title">${territoryInfo.name}</div>
                                <div class="event-status">${territory.controlledBy ? 'CONTROLLED' : 'UNCLAIMED'}</div>
                            </div>
                            <div class="event-details">
                                Bonus: ${territoryInfo.bonus}
                            </div>
                            <div class="event-details">
                                Controlled by: <strong>${territory.controlledBy || 'None'}</strong>
                            </div>
                            <div class="event-details">
                                Weekly Points: +${territoryInfo.points}
                            </div>
                            <div class="event-actions">
                                <button class="btn btn-success" onclick="claimTerritory('${territoryId}', 'De Supreme Family')">Give to Supreme</button>
                                <button class="btn btn-success" onclick="claimTerritory('${territoryId}', 'De Speed Family')">Give to Speed</button>
                                <button class="btn btn-success" onclick="claimTerritory('${territoryId}', 'De Reliable Family')">Give to Reliable</button>
                                <button class="btn btn-danger" onclick="claimTerritory('${territoryId}', 'none')">Make Neutral</button>
                            </div>
                        `;
                        territoriesList.appendChild(territoryCard);
                    });
                })
                .catch((error) => {
                    console.error('Error loading territories:', error);
                    territoriesList.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading territories</p></div>';
                });
        }

        // Initialize Territories
        function initializeTerritories() {
            const initialTerritories = {};
            Object.keys(territoriesConfig).forEach(territoryId => {
                initialTerritories[territoryId] = {
                    controlledBy: null,
                    controlledSince: null,
                    familyName: null,
                    currentBonus: territoriesConfig[territoryId].value,
                    lastDistribution: null
                };
            });
            
            database.ref('territories').set(initialTerritories)
                .then(() => {
                    loadTerritories();
                })
                .catch((error) => {
                    console.error('Error initializing territories:', error);
                });
        }

        // ========== WEEKLY BONUSES FUNCTIONS ==========

        function loadWeeklyBonuses() {
            const bonusGrid = document.getElementById('bonus-grid');
            bonusGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            database.ref('weeklyBonuses').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        return initializeManualBonuses();
                    }
                    return snapshot;
                })
                .then((snapshot) => {
                    const bonuses = snapshot.val();
                    let bonusHTML = '';
                    
                    Object.keys(bonuses).forEach(bonusId => {
                        const bonus = bonuses[bonusId];
                        
                        bonusHTML += `
                            <div class="bonus-card ${bonus.active ? 'active' : ''}">
                                <div class="bonus-name">${bonus.name}</div>
                                <div class="bonus-value">+${bonus.value} Points</div>
                                <div class="bonus-description">${bonus.description}</div>
                                
                                <div class="bonus-controls">
                                    <div class="form-group">
                                        <label>Winner Family:</label>
                                        <select class="form-control bonus-winner" data-bonusid="${bonusId}">
                                            <option value="">-- No Winner --</option>
                                            <option value="De Supreme Family" ${bonus.winner === 'De Supreme Family' ? 'selected' : ''}>De Supreme Family</option>
                                            <option value="De Speed Family" ${bonus.winner === 'De Speed Family' ? 'selected' : ''}>De Speed Family</option>
                                            <option value="De Reliable Family" ${bonus.winner === 'De Reliable Family' ? 'selected' : ''}>De Reliable Family</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Points Value:</label>
                                        <input type="number" class="form-control bonus-points" data-bonusid="${bonusId}" value="${bonus.value}" min="0" max="1000">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Active:</label>
                                        <select class="form-control bonus-active" data-bonusid="${bonusId}">
                                            <option value="true" ${bonus.active ? 'selected' : ''}>Active</option>
                                            <option value="false" ${!bonus.active ? 'selected' : ''}>Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="bonus-actions">
                                        <button class="btn btn-success save-bonus" data-bonusid="${bonusId}">💾 Save</button>
                                        <button class="btn btn-warning distribute-now" data-bonusid="${bonusId}">🎁 Distribute Now</button>
                                    </div>
                                    
                                    ${bonus.winner ? `
                                        <div class="current-winner">
                                            <strong>Current Winner:</strong> ${bonus.winner}
                                            ${bonus.lastAwarded ? `<br><small>Last awarded: ${new Date(bonus.lastAwarded).toLocaleDateString()}</small>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    bonusGrid.innerHTML = bonusHTML;
                    
                    document.querySelectorAll('.save-bonus').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const bonusId = e.target.dataset.bonusid;
                            saveBonusSettings(bonusId);
                        });
                    });
                    
                    document.querySelectorAll('.distribute-now').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const bonusId = e.target.dataset.bonusid;
                            distributeBonusNow(bonusId);
                        });
                    });
                })
                .catch((error) => {
                    console.error('Error loading weekly bonuses:', error);
                    bonusGrid.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading bonuses</p></div>';
                });
        }

        function initializeManualBonuses() {
            const manualBonuses = {
                'top_family': {
                    name: 'Top Family Bonus',
                    description: 'Award manually based on your discretion',
                    value: 500,
                    type: 'points',
                    active: true,
                    winner: null,
                    lastAwarded: null,
                    manualControl: true
                },
                'most_active': {
                    name: 'Most Active Family', 
                    description: 'Award manually - consider actual patronage',
                    value: 300,
                    type: 'points',
                    active: true,
                    winner: null,
                    lastAwarded: null,
                    manualControl: true
                },
                'territory_dominance': {
                    name: 'Territory Dominance',
                    description: 'Award manually - strategic value only',
                    value: 400, 
                    type: 'points',
                    active: true,
                    winner: null,
                    lastAwarded: null,
                    manualControl: true
                },
                'special_recognition': {
                    name: 'Special Recognition',
                    description: 'Your discretionary bonus for exceptional cases',
                    value: 200,
                    type: 'points', 
                    active: true,
                    winner: null,
                    lastAwarded: null,
                    manualControl: true
                }
            };
            
            return database.ref('weeklyBonuses').set(manualBonuses);
        }

        function saveBonusSettings(bonusId) {
            const winnerSelect = document.querySelector(`.bonus-winner[data-bonusid="${bonusId}"]`);
            const pointsInput = document.querySelector(`.bonus-points[data-bonusid="${bonusId}"]`);
            const activeSelect = document.querySelector(`.bonus-active[data-bonusid="${bonusId}"]`);
            
            const updates = {
                winner: winnerSelect.value || null,
                value: parseInt(pointsInput.value) || 0,
                active: activeSelect.value === 'true',
                lastUpdated: Date.now()
            };
            
            database.ref(`weeklyBonuses/${bonusId}`).update(updates)
                .then(() => {
                    alert('✅ Bonus settings saved!');
                    loadWeeklyBonuses();
                })
                .catch((error) => {
                    alert('❌ Error saving bonus: ' + error.message);
                });
        }

        function distributeBonusNow(bonusId) {
            if (!confirm('Distribute these bonus points to the selected family?')) return;
            
            showLoading();
            
            database.ref(`weeklyBonuses/${bonusId}`).once('value')
                .then((snapshot) => {
                    const bonus = snapshot.val();
                    
                    if (!bonus.winner) {
                        throw new Error('Please select a winner family first');
                    }
                    
                    if (!bonus.active) {
                        throw new Error('This bonus is not active');
                    }
                    
                    return distributePointsToFamily(bonus.winner, bonus.value, bonus.name);
                })
                .then(() => {
                    return database.ref(`weeklyBonuses/${bonusId}`).update({
                        lastAwarded: Date.now()
                    });
                })
                .then(() => {
                    hideLoading();
                    alert(`✅ Bonus points distributed to ${bonus.winner}!`);
                    loadWeeklyBonuses();
                })
                .catch((error) => {
                    hideLoading();
                    alert('❌ Error distributing bonus: ' + error.message);
                });
        }

        function distributePointsToFamily(familyName, points, reason) {
            return database.ref('users').orderByChild('role').equalTo('customer').once('value')
                .then((snapshot) => {
                    const updates = {};
                    const pointsHistoryUpdates = {};
                    let memberCount = 0;
                    
                    snapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        const userFamily = getGeographicalLocation(userData.email);
                        
                        if (userFamily === familyName) {
                            memberCount++;
                            
                            const pointsHistoryId = 'bonus_' + Date.now() + '_' + memberCount;
                            pointsHistoryUpdates[`pointsHistory/${pointsHistoryId}`] = {
                                pointsAdded: points,
                                reason: `Weekly Bonus: ${reason}`,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                customerEmail: userData.email,
                                customerId: userSnapshot.key,
                                source: 'weekly_bonus',
                                family: familyName,
                                bonusType: reason
                            };
                            
                            const notificationId = 'bonus_' + Date.now();
                            updates[`notifications/${userSnapshot.key}/${notificationId}`] = {
                                userId: userSnapshot.key,
                                userEmail: userData.email,
                                type: 'weekly_bonus',
                                title: '🎉 Weekly Bonus Awarded!',
                                message: `Your family received ${points} respect points for: ${reason}`,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                read: false
                            };
                        }
                    });
                    
                    if (memberCount === 0) {
                        throw new Error('No family members found to award points to');
                    }
                    
                    return database.ref().update(pointsHistoryUpdates)
                        .then(() => database.ref().update(updates))
                        .then(() => memberCount);
                });
        }

        // War Management Functions
        function updateWarScore(warId, family) {
            database.ref('familyEvents/' + warId).once('value')
                .then((snapshot) => {
                    const war = snapshot.val();
                    const updates = {};
                    
                    if (family === war.family1) {
                        updates['score1'] = (war.score1 || 0) + 1;
                    } else {
                        updates['score2'] = (war.score2 || 0) + 1;
                    }
                    
                    updates['participants'] = (war.participants || 0) + 1;
                    
                    return database.ref('familyEvents/' + warId).update(updates);
                })
                .then(() => {
                    loadActiveWars();
                    createAdminNotification(`War score updated: ${family} +1 point`, 'war_updated');
                })
                .catch((error) => {
                    alert('Error updating war score: ' + error.message);
                });
        }

        function endWar(warId) {
            if (!confirm('End this war and declare a winner?')) return;
            
            showLoading();
            
            database.ref('familyEvents/' + warId).once('value')
                .then((snapshot) => {
                    const war = snapshot.val();
                    let winner = null;
                    
                    if (war.score1 > war.score2) {
                        winner = war.family1;
                    } else if (war.score2 > war.score1) {
                        winner = war.family2;
                    } else {
                        winner = 'Draw';
                    }
                    
                    const updates = {
                        status: 'completed',
                        winner: winner,
                        endedAt: Date.now()
                    };
                    
                    return database.ref('familyEvents/' + warId).update(updates);
                })
                .then(() => {
                    hideLoading();
                    alert('War completed!');
                    loadActiveWars();
                    loadWarStatistics();
                    
                    // Send victory notifications
                    database.ref('familyEvents/' + warId).once('value')
                        .then((snapshot) => {
                            const war = snapshot.val();
                            if (war.winner && war.winner !== 'Draw') {
                                sendWarNotification(war.family1, war.family2, war.name, 'completed', war.winner);
                                sendWarNotification(war.family2, war.family1, war.name, 'completed', war.winner);
                            }
                        });
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error ending war: ' + error.message);
                });
        }

        function cancelWar(warId) {
            if (!confirm('Cancel this war? This cannot be undone.')) return;
            
            showLoading();
            
            database.ref('familyEvents/' + warId).update({
                status: 'cancelled',
                cancelledAt: Date.now()
            })
            .then(() => {
                hideLoading();
                alert('War cancelled!');
                loadActiveWars();
            })
            .catch((error) => {
                hideLoading();
                alert('Error cancelling war: ' + error.message);
            });
        }

        function completeWar(war) {
            let winner = null;
            
            if (war.score1 > war.score2) {
                winner = war.family1;
            } else if (war.score2 > war.score1) {
                winner = war.family2;
            } else {
                winner = 'Draw';
            }
            
            database.ref('familyEvents/' + war.id).update({
                status: 'completed',
                winner: winner,
                endedAt: Date.now()
            })
            .then(() => {
                // Send victory notifications
                if (winner && winner !== 'Draw') {
                    sendWarNotification(war.family1, war.family2, war.name, 'completed', winner);
                    sendWarNotification(war.family2, war.family1, war.name, 'completed', winner);
                }
                createAdminNotification(`War auto-completed: ${war.name} - Winner: ${winner}`, 'war_completed');
            });
        }

        // Challenge Management Functions
        function updateChallengeScore(challengeId, side) {
            database.ref('challenges/' + challengeId).once('value')
                .then((snapshot) => {
                    const challenge = snapshot.val();
                    const updates = {};
                    
                    if (side === 'challenger') {
                        updates['challengerPoints'] = (challenge.challengerPoints || 0) + 1;
                    } else {
                        updates['defenderPoints'] = (challenge.defenderPoints || 0) + 1;
                    }
                    
                    return database.ref('challenges/' + challengeId).update(updates);
                })
                .then(() => {
                    loadActiveChallenges();
                    createAdminNotification(`Challenge score updated`, 'challenge_updated');
                })
                .catch((error) => {
                    alert('Error updating challenge score: ' + error.message);
                });
        }

        function endChallenge(challengeId) {
            if (!confirm('End this challenge and declare a winner?')) return;
            
            showLoading();
            
            database.ref('challenges/' + challengeId).once('value')
                .then((snapshot) => {
                    const challenge = snapshot.val();
                    let winner = null;
                    
                    if (challenge.challengerPoints > challenge.defenderPoints) {
                        winner = challenge.challengerFamily;
                    } else if (challenge.defenderPoints > challenge.challengerPoints) {
                        winner = challenge.defenderFamily;
                    } else {
                        winner = 'Draw';
                    }
                    
                    const updates = {
                        status: 'completed',
                        winner: winner,
                        endedAt: Date.now()
                    };
                    
                    return database.ref('challenges/' + challengeId).update(updates);
                })
                .then(() => {
                    hideLoading();
                    alert('Challenge completed!');
                    loadActiveChallenges();
                    loadWarStatistics();
                    
                    // Send victory notifications
                    database.ref('challenges/' + challengeId).once('value')
                        .then((snapshot) => {
                            const challenge = snapshot.val();
                            if (challenge.winner && challenge.winner !== 'Draw') {
                                sendChallengeNotification(challenge.challengerFamily, challenge.defenderFamily, challenge.name, 'completed', challenge.winner);
                                sendChallengeNotification(challenge.defenderFamily, challenge.challengerFamily, challenge.name, 'completed', challenge.winner);
                            }
                        });
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error ending challenge: ' + error.message);
                });
        }

        function cancelChallenge(challengeId) {
            if (!confirm('Cancel this challenge? This cannot be undone.')) return;
            
            showLoading();
            
            database.ref('challenges/' + challengeId).update({
                status: 'cancelled',
                cancelledAt: Date.now()
            })
            .then(() => {
                hideLoading();
                alert('Challenge cancelled!');
                loadActiveChallenges();
            })
            .catch((error) => {
                hideLoading();
                alert('Error cancelling challenge: ' + error.message);
            });
        }

        function completeChallenge(challenge) {
            let winner = null;
            
            if (challenge.challengerPoints > challenge.defenderPoints) {
                winner = challenge.challengerFamily;
            } else if (challenge.defenderPoints > challenge.challengerPoints) {
                winner = challenge.defenderFamily;
            } else {
                winner = 'Draw';
            }
            
            database.ref('challenges/' + challenge.id).update({
                status: 'completed',
                winner: winner,
                endedAt: Date.now()
            })
            .then(() => {
                // Send victory notifications
                if (winner && winner !== 'Draw') {
                    sendChallengeNotification(challenge.challengerFamily, challenge.defenderFamily, challenge.name, 'completed', winner);
                    sendChallengeNotification(challenge.defenderFamily, challenge.challengerFamily, challenge.name, 'completed', winner);
                }
                createAdminNotification(`Challenge auto-completed: ${challenge.name} - Winner: ${winner}`, 'challenge_completed');
            });
        }

        // Territory Management Functions
        function claimTerritory(territoryId, familyName) {
            showLoading();
            
            const territoryData = {
                controlledBy: familyName === 'none' ? null : familyName,
                controlledSince: familyName === 'none' ? null : Date.now(),
                familyName: familyName === 'none' ? null : familyName,
                currentBonus: territoriesConfig[territoryId].value,
                lastDistribution: null
            };

            database.ref('territories/' + territoryId).set(territoryData)
                .then(() => {
                    hideLoading();
                    loadTerritories();
                    
                    if (familyName !== 'none') {
                        createAdminNotification(`Territory ${territoriesConfig[territoryId].name} claimed by ${familyName}`, 'territory_claimed');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error claiming territory: ' + error.message);
                });
        }

        function resetAllTerritories() {
            if (!confirm('Reset all territories to neutral? This will remove all family control.')) return;
            
            showLoading();
            
            const updates = {};
            Object.keys(territoriesConfig).forEach(territoryId => {
                updates[territoryId] = {
                    controlledBy: null,
                    controlledSince: null,
                    familyName: null,
                    currentBonus: territoriesConfig[territoryId].value,
                    lastDistribution: null
                };
            });
            
            database.ref('territories').set(updates)
                .then(() => {
                    hideLoading();
                    alert('All territories reset to neutral!');
                    loadTerritories();
                    createAdminNotification('All territories reset to neutral', 'territory_reset');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error resetting territories: ' + error.message);
                });
        }

        function assignRandomTerritories() {
            if (!confirm('Randomly assign all territories to families?')) return;
            
            showLoading();
            
            const updates = {};
            const familyKeys = Object.keys(families);
            
            Object.keys(territoriesConfig).forEach(territoryId => {
                const randomFamily = families[Math.floor(Math.random() * familyKeys.length)];
                updates[territoryId] = {
                    controlledBy: randomFamily,
                    controlledSince: Date.now(),
                    familyName: randomFamily,
                    currentBonus: territoriesConfig[territoryId].value,
                    lastDistribution: null
                };
            });
            
            database.ref('territories').set(updates)
                .then(() => {
                    hideLoading();
                    alert('Territories randomly assigned!');
                    loadTerritories();
                    createAdminNotification('Territories randomly assigned to families', 'territory_random');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error assigning territories: ' + error.message);
                });
        }

        function calculateTerritoryBonuses() {
            showLoading();
            
            database.ref('territories').once('value')
                .then((snapshot) => {
                    const territories = snapshot.val();
                    let totalBonuses = {};
                    
                    families.forEach(family => {
                        totalBonuses[family] = 0;
                    });
                    
                    Object.keys(territories).forEach(territoryId => {
                        const territory = territories[territoryId];
                        if (territory.familyName && families.includes(territory.familyName)) {
                            totalBonuses[territory.familyName] += territoriesConfig[territoryId].points;
                        }
                    });
                    
                    hideLoading();
                    
                    let message = "Weekly Territory Bonuses:\n\n";
                    families.forEach(family => {
                        message += `${family}: +${totalBonuses[family]} points\n`;
                    });
                    
                    alert(message);
                    createAdminNotification('Territory bonuses calculated', 'territory_bonuses');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error calculating bonuses: ' + error.message);
                });
        }

        function distributeTerritoryRewards() {
            if (!confirm('Distribute territory rewards to all family members?')) return;
            
            showLoading();
            
            // This would distribute points to all members of families controlling territories
            // Implementation would depend on your specific points distribution logic
            setTimeout(() => {
                hideLoading();
                alert('Territory rewards distributed!');
                createAdminNotification('Territory rewards distributed to families', 'territory_rewards');
            }, 2000);
        }

        // Load War Statistics
        function loadWarStatistics() {
            // Load total wars count
            database.ref('familyEvents').orderByChild('type').equalTo('war').once('value')
                .then((snapshot) => {
                    const totalWars = snapshot.numChildren();
                    document.getElementById('total-wars').textContent = totalWars;
                    
                    let activeWars = 0;
                    const now = Date.now();
                    const warResults = [];
                    
                    snapshot.forEach(warSnapshot => {
                        const war = warSnapshot.val();
                        if (war.endTime > now && war.status === 'active') {
                            activeWars++;
                        }
                        
                        if (war.status === 'completed') {
                            warResults.push(war);
                        }
                    });
                    
                    document.getElementById('active-wars-count').textContent = activeWars;
                    
                    // Populate war results table
                    const warResultsTable = document.getElementById('war-results-table');
                    warResultsTable.innerHTML = '';
                    
                    warResults.slice(0, 10).forEach(war => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${war.name}</td>
                            <td>${war.family1} vs ${war.family2}</td>
                            <td>${war.winner || 'Draw'}</td>
                            <td>${new Date(war.endedAt).toLocaleDateString()}</td>
                            <td>${war.score1 || 0} - ${war.score2 || 0}</td>
                        `;
                        warResultsTable.appendChild(row);
                    });
                });
            
            // Load challenges count
            database.ref('challenges').once('value')
                .then((snapshot) => {
                    const totalChallenges = snapshot.numChildren();
                    document.getElementById('total-challenges').textContent = totalChallenges;
                    
                    let activeChallenges = 0;
                    const now = Date.now();
                    
                    snapshot.forEach(challengeSnapshot => {
                        const challenge = challengeSnapshot.val();
                        if (challenge.endTime > now && challenge.status === 'active') {
                            activeChallenges++;
                        }
                    });
                    
                    document.getElementById('active-challenges-count').textContent = activeChallenges;
                });
            
            // Load family performance
            loadFamilyPerformance();
        }

        function loadFamilyPerformance() {
            const performanceTable = document.getElementById('family-performance-table');
            performanceTable.innerHTML = '';
            
            // This would require more complex data aggregation
            // For now, we'll show placeholder data
            families.forEach(family => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${family}</td>
                    <td>${Math.floor(Math.random() * 5)}</td>
                    <td>${Math.floor(Math.random() * 3)}</td>
                    <td>${Math.floor(Math.random() * 2)}</td>
                    <td>${Math.floor(Math.random() * 1000) + 500}</td>
                `;
                performanceTable.appendChild(row);
            });
        }

        // Notification Functions
        function sendWarNotification(family1, family2, warName, action, winner = null) {
            let title = '';
            let message = '';
            
            switch(action) {
                case 'declared':
                    title = '⚔️ War Declared!';
                    message = `A war has been declared between ${family1} and ${family2}: ${warName}. Fight for honor and points!`;
                    break;
                case 'completed':
                    title = '🏆 War Completed!';
                    message = `The war ${warName} has ended. Winner: ${winner}!`;
                    break;
            }
            
            sendFamilyNotification(family1, title, message, 'family_war');
            if (family1 !== family2) {
                sendFamilyNotification(family2, title, message, 'family_war');
            }
        }

        function sendChallengeNotification(challenger, defender, challengeName, action, winner = null) {
            let title = '';
            let message = '';
            
            switch(action) {
                case 'challenged':
                    title = '🎯 Challenge Received!';
                    message = `${challenger} has challenged you to: ${challengeName}. Defend your honor!`;
                    break;
                case 'accepted':
                    title = '🎯 Challenge Accepted!';
                    message = `You have been challenged by ${challenger} to: ${challengeName}. Prepare for battle!`;
                    break;
                case 'completed':
                    title = '🏆 Challenge Completed!';
                    message = `The challenge ${challengeName} has ended. Winner: ${winner}!`;
                    break;
            }
            
            sendFamilyNotification(defender, title, message, 'omerta_challenge');
            if (challenger !== defender) {
                sendFamilyNotification(challenger, title, message, 'omerta_challenge');
            }
        }

        function sendFamilyNotification(familyName, title, message, type) {
            database.ref('users').orderByChild('role').equalTo('customer').once('value')
                .then((snapshot) => {
                    const promises = [];
                    
                    snapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        // This would need the getGeographicalLocation function from the customer code
                        // For now, we'll send to all customers
                        const userFamily = getGeographicalLocation(userData.email);
                        
                        if (userFamily === familyName) {
                            const notificationId = 'family_notification_' + Date.now();
                            const notificationData = {
                                userId: userSnapshot.key,
                                userEmail: userData.email,
                                type: type,
                                title: title,
                                message: message,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                read: false,
                                fromAdmin: true
                            };
                            promises.push(
                                database.ref('notifications/' + userSnapshot.key + '/' + notificationId).set(notificationData)
                            );
                        }
                    });
                    
                    return Promise.all(promises);
                })
                .catch((error) => {
                    console.error('Error sending family notification:', error);
                });
        }

        // ORIGINAL CORE FUNCTIONS (Now included)
        function calculateCustomerPoints(customerEmail) {
            return new Promise((resolve) => {
                let totalPoints = 0;
                
                console.log('🧮 Calculating total points for:', customerEmail);
                
                Promise.all([
                    database.ref('customers').orderByChild('email').equalTo(customerEmail).once('value'),
                    database.ref('pointsHistory').orderByChild('customerEmail').equalTo(customerEmail).once('value'),
                    database.ref('redemptions').orderByChild('customerEmail').equalTo(customerEmail).once('value')
                ])
                .then(([ordersSnapshot, pointsSnapshot, redemptionsSnapshot]) => {
                    
                    console.log('📊 Data sources found:', {
                        orders: ordersSnapshot.numChildren(),
                        pointsHistory: pointsSnapshot.numChildren(),
                        redemptions: redemptionsSnapshot.numChildren()
                    });

                    // Calculate from orders (laundry operations)
                    if (ordersSnapshot.exists()) {
                        ordersSnapshot.forEach(orderSnapshot => {
                            const order = orderSnapshot.val();
                            const points = parseInt(order.points) || 0;
                            totalPoints += points;
                            console.log('➕ Order points:', points, 'Total:', totalPoints);
                        });
                    }

                    // Calculate from manual points (admin granted)
                    if (pointsSnapshot.exists()) {
                        pointsSnapshot.forEach(pointSnapshot => {
                            const point = pointSnapshot.val();
                            const points = parseInt(point.pointsAdded) || 0;
                            totalPoints += points;
                            console.log('➕ Manual points:', points, 'Total:', totalPoints);
                        });
                    }

                    // Subtract redeemed points
                    if (redemptionsSnapshot.exists()) {
                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                            const redemption = redemptionSnapshot.val();
                            const points = parseInt(redemption.pointsUsed) || 0;
                            totalPoints -= points;
                            console.log('➖ Redeemed points:', points, 'Total:', totalPoints);
                        });
                    }

                    console.log('✅ Final points for', customerEmail + ':', totalPoints);
                    resolve(totalPoints);
                })
                .catch(error => {
                    console.error('❌ Points calculation failed:', error);
                    resolve(0);
                });
            });
        }

        function generateRankings() {
            if (!hasAdminAccess()) {
                alert('Admin access required to generate rankings');
                return;
            }
            
            showLoading();
            console.log("🔄 Generating rankings from ALL data sources...");
            
            database.ref('users').orderByChild('role').equalTo('customer').once('value')
                .then((usersSnapshot) => {
                    console.log("👥 Found customers:", usersSnapshot.numChildren());
                    
                    if (!usersSnapshot.exists()) {
                        hideLoading();
                        alert('No customer accounts found!');
                        return;
                    }
                    
                    const customerPromises = [];
                    const customersData = [];
                    
                    usersSnapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        const userEmail = userData.email;
                        
                        if (userEmail) {
                            const promise = calculateCustomerPoints(userEmail).then(totalPoints => {
                                customersData.push({
                                    name: userData.name || userEmail.split('@')[0],
                                    email: userEmail,
                                    userId: userSnapshot.key,
                                    totalPoints: totalPoints,
                                    phone: userData.phone || 'Not provided',
                                    createdAt: userData.createdAt || Date.now()
                                });
                            });
                            customerPromises.push(promise);
                        }
                    });
                    
                    return Promise.all(customerPromises).then(() => customersData);
                })
                .then((customersData) => {
                    console.log("📊 Customers with calculated points:", customersData.length);
                    
                    customersData.sort((a, b) => b.totalPoints - a.totalPoints);
                    
                    const rankings = {};
                    customersData.forEach((customer, index) => {
                        const rankId = 'rank_' + customer.userId;
                        rankings[rankId] = {
                            name: customer.name,
                            email: customer.email,
                            points: customer.totalPoints,
                            currentBalance: customer.totalPoints,
                            rank: index + 1,
                            userId: customer.userId,
                            phone: customer.phone,
                            createdAt: customer.createdAt,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        };
                    });
                    
                    console.log("🏆 Final rankings to save:", rankings);
                    
                    return database.ref('rankings').set(rankings);
                })
                .then(() => {
                    console.log("✅ Rankings saved successfully!");
                    hideLoading();
                    alert('🏆 Rankings generated from ALL points sources!');
                    loadRankings();
                    createAdminNotification('Rankings generated successfully', 'system_maintenance');
                })
                .catch((error) => {
                    console.error('❌ Error generating rankings:', error);
                    hideLoading();
                    alert('Error: ' + error.message);
                });
        }

        function loadRankings() {
            showLoading();
            
            database.ref('rankings').orderByChild('rank').once('value')
                .then((snapshot) => {
                    const rankingsList = document.getElementById('overall-rankings');
                    rankingsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        rankingsList.innerHTML = `
                            <div class="empty-state">
                                <div>👥</div>
                                <p>No rankings generated yet</p>
                                <p>Click "Generate Rankings" to create rankings from all customer data</p>
                            </div>`;
                        hideLoading();
                        return;
                    }
                    
                    const rankings = [];
                    snapshot.forEach(rankSnapshot => {
                        const rankData = rankSnapshot.val();
                        rankings.push(rankData);
                    });
                    
                    rankings.sort((a, b) => a.rank - b.rank);
                    
                    if (rankings.length === 0) {
                        rankingsList.innerHTML = '<div class="empty-state"><div>👥</div><p>No rankings found</p></div>';
                    } else {
                        rankings.forEach((rank) => {
                            const rankingItem = document.createElement('div');
                            rankingItem.className = 'ranking-item';
                            
                            const family = getGeographicalLocation(rank.email);
                            
                            let badgeColor = '#d4af37';
                            let rankTitle = 'Associate';
                            
                            if (rank.rank === 1) {
                                badgeColor = '#FFD700';
                                rankTitle = 'Boss';
                            } else if (rank.rank === 2) {
                                badgeColor = '#C0C0C0';
                                rankTitle = 'Underboss';
                            } else if (rank.rank === 3) {
                                badgeColor = '#CD7F32';
                                rankTitle = 'Capo';
                            } else if (rank.rank <= 10) {
                                badgeColor = '#8B0000';
                                rankTitle = 'Soldier';
                            }
                            
                            rankingItem.innerHTML = `
                                <div class="ranking-info">
                                    <div class="rank-badge" style="background: ${badgeColor}">${rank.rank}</div>
                                    <div>
                                        <div class="customer-name">${rank.name} <small style="color: #d4af37;">(${rankTitle})</small></div>
                                        <div class="customer-email">${rank.email}</div>
                                        <div class="geographical-location">${family}</div>
                                        <div style="font-size: 0.8rem; color: #ccc;">${rank.phone}</div>
                                    </div>
                                </div>
                                <div class="respect-points">${rank.points} Respect</div>
                            `;
                            
                            rankingsList.appendChild(rankingItem);
                        });
                    }
                    
                    loadFamilyGeographicalRankings(rankings);
                })
                .catch((error) => {
                    document.getElementById('overall-rankings').innerHTML = 
                        '<div class="empty-state"><div>❌</div><p>Error loading rankings</p></div>';
                    hideLoading();
                });
        }

        function loadFamilyGeographicalRankings(rankings) {
            const familiesOverview = document.getElementById('families-overview');
            
            familyStats = {};
            families.forEach(family => {
                familyStats[family] = { 
                    members: 0, 
                    totalRespect: 0, 
                    avgRespect: 0,
                    highestRespect: 0,
                    highestMember: '',
                    rankDistribution: {
                        associate: 0,
                        soldier: 0,
                        capo: 0,
                        underboss: 0,
                        boss: 0
                    }
                };
            });
            
            rankings.forEach(rank => {
                const family = getGeographicalLocation(rank.email);
                familyStats[family].members++;
                familyStats[family].totalRespect += rank.points || 0;
                
                let memberRank = 'associate';
                if (rank.points >= 1000 && rank.points < 3000) memberRank = 'soldier';
                else if (rank.points >= 3000 && rank.points < 6000) memberRank = 'capo';
                else if (rank.points >= 6000 && rank.points < 10000) memberRank = 'underboss';
                else if (rank.points >= 10000) memberRank = 'boss';
                
                familyStats[family].rankDistribution[memberRank]++;
                
                if (rank.points > familyStats[family].highestRespect) {
                    familyStats[family].highestRespect = rank.points;
                    familyStats[family].highestMember = rank.name || rank.email;
                }
            });
            
            let maxTotalRespect = 0;
            Object.keys(familyStats).forEach(family => {
                if (familyStats[family].members > 0) {
                    familyStats[family].avgRespect = Math.round(familyStats[family].totalRespect / familyStats[family].members);
                }
                
                if (familyStats[family].totalRespect > maxTotalRespect) {
                    maxTotalRespect = familyStats[family].totalRespect;
                    leadingFamily = family;
                }
            });
            
            const sortedFamilies = Object.keys(familyStats).sort((a, b) => 
                familyStats[b].totalRespect - familyStats[a].totalRespect
            );
            
            let familiesHTML = '<div class="families-list">';
            
            if (leadingFamily) {
                const leadingStats = familyStats[leadingFamily];
                familiesHTML += `
                    <div class="leading-family-card" onclick="showLeadingFamilyModal()">
                        <div class="leading-family-badge">🏆 LEADING FAMILY</div>
                        <h4 class="family-name">${leadingFamily}</h4>
                        <div class="family-stats">
                            <div>👥 ${leadingStats.members} Members</div>
                            <div>⭐ ${leadingStats.totalRespect} Total Respect</div>
                            <div>📊 ${leadingStats.avgRespect} Avg Respect</div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #d4af37;">
                            Click to view detailed breakdown
                        </div>
                    </div>
                `;
            }
            
            sortedFamilies.forEach(family => {
                if (family !== leadingFamily) {
                    const stats = familyStats[family];
                    familiesHTML += `
                        <div class="family-card" onclick="showFamilyModal('${family}')">
                            <h4 class="family-name">${family}</h4>
                            <div class="family-stats">
                                <div>👥 ${stats.members} Members</div>
                                <div>⭐ ${stats.totalRespect} Total Respect</div>
                                <div>📊 ${stats.avgRespect} Avg Respect</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            familiesHTML += '</div>';
            familiesOverview.innerHTML = familiesHTML;
            
            hideLoading();
        }

        function loadAvailableJobs() {
            if (!hasAdminAccess()) {
                alert('Admin access required');
                return;
            }
            
            showLoading();
            
            database.ref('availableJobs').once('value')
                .then((snapshot) => {
                    const jobsList = document.getElementById('available-jobs-list');
                    jobsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        jobsList.innerHTML = '<div class="empty-state"><div>💼</div><p>No available jobs</p></div>';
                        hideLoading();
                        return;
                    }
                    
                    const jobs = snapshot.val();
                    
                    for (const jobId in jobs) {
                        const job = jobs[jobId];
                        const jobItem = document.createElement('div');
                        jobItem.className = 'job-item';
                        
                        jobItem.innerHTML = `
                            <div class="job-header">
                                <h4 class="job-title">${job.title}</h4>
                                <span class="job-points">${job.points} Respect</span>
                            </div>
                            <p class="job-description">${job.description}</p>
                            <div class="job-actions">
                                <button class="btn btn-danger delete-job" data-jobid="${jobId}">Delete</button>
                            </div>
                        `;
                        
                        jobsList.appendChild(jobItem);
                    }
                    
                    document.querySelectorAll('.delete-job').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            if (!hasAdminAccess()) {
                                alert('Admin access required to delete jobs');
                                return;
                            }
                            const jobId = e.target.dataset.jobid;
                            deleteJob(jobId);
                        });
                    });
                    
                    hideLoading();
                })
                .catch((error) => {
                    document.getElementById('available-jobs-list').innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading jobs</p></div>';
                    hideLoading();
                });
        }

        function addNewJob() {
            const title = document.getElementById('job-title').value;
            const description = document.getElementById('job-description').value;
            const points = parseInt(document.getElementById('job-points').value);
            const type = document.getElementById('job-type').value;
            
            if (!title || !description || isNaN(points)) {
                alert('Please fill in all fields correctly.');
                return;
            }
            
            showLoading();
            
            const jobData = {
                title: title,
                description: description,
                points: points,
                type: type,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: currentAdminUser.uid
            };
            
            database.ref('availableJobs/' + Date.now()).set(jobData)
                .then(() => {
                    hideLoading();
                    alert('Job created successfully!');
                    document.getElementById('add-job-form').reset();
                    loadAvailableJobs();
                    createAdminNotification(`New job created: ${title}`, 'system');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error creating job. Please try again.');
                });
        }

        function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            
            showLoading();
            
            database.ref('availableJobs/' + jobId).remove()
                .then(() => {
                    hideLoading();
                    alert('Job deleted successfully!');
                    loadAvailableJobs();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error deleting job. Please try again.');
                });
        }

        function loadJobRequests() {
            if (!hasAdminAccess()) {
                alert('Admin access required');
                return;
            }
            
            showLoading();
            
            console.log("Loading job requests from Firebase...");
            
            database.ref('jobRequests').orderByChild('timestamp').once('value')
                .then((snapshot) => {
                    const requestsList = document.getElementById('job-requests-list');
                    requestsList.innerHTML = '';
                    
                    console.log("Job requests snapshot received:", snapshot.numChildren(), "requests");
                    
                    if (!snapshot.exists()) {
                        requestsList.innerHTML = '<div class="empty-state"><div>📋</div><p>No pending job requests</p></div>';
                        hideLoading();
                        return;
                    }
                    
                    const requests = [];
                    
                    snapshot.forEach(requestSnapshot => {
                        const request = requestSnapshot.val();
                        request.id = requestSnapshot.key;
                        
                        console.log("Found request:", request);
                        
                        if (request.status === 'pending') {
                            requests.push(request);
                        }
                    });
                    
                    console.log("Filtered pending requests:", requests.length);
                    
                    requests.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (requests.length === 0) {
                        requestsList.innerHTML = '<div class="empty-state"><div>📋</div><p>No pending job requests</p></div>';
                    } else {
                        requests.forEach(request => {
                            const requestItem = document.createElement('div');
                            requestItem.className = 'job-request-item';
                            
                            const date = new Date(request.timestamp).toLocaleString();
                            const jobDisplay = request.jobTitle || request.jobType || 'Unknown Job';
                            const requestType = request.jobType === 'available_job' ? 'Available Job' : 'Quick Job';
                            
                            requestItem.innerHTML = `
                                <div class="request-header">
                                    <span class="request-type">${requestType}</span>
                                    <span class="request-date">${date}</span>
                                </div>
                                <div class="request-details">
                                    <div class="request-user">
                                        <strong>Associate:</strong> ${request.userName} (${request.userEmail})
                                    </div>
                                    <div class="request-content">
                                        <strong>Job:</strong> ${jobDisplay}
                                    </div>
                                    ${request.jobDescription ? `
                                    <div class="request-content">
                                        <strong>Description:</strong> ${request.jobDescription}
                                    </div>
                                    ` : ''}
                                    <div class="request-points">
                                        <strong>Respect Points:</strong> ${request.points}
                                    </div>
                                    <div class="request-status">
                                        <strong>Status:</strong> ${request.status}
                                    </div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn btn-success approve-request" 
                                            data-requestid="${request.id}" 
                                            data-userid="${request.userId}" 
                                            data-useremail="${request.userEmail}"
                                            data-points="${request.points}" 
                                            data-jobtype="${request.jobType}"
                                            data-jobid="${request.jobId}"
                                            data-jobtitle="${jobDisplay}">Approve</button>
                                    <button class="btn btn-danger reject-request" 
                                            data-requestid="${request.id}" 
                                            data-userid="${request.userId}"
                                            data-useremail="${request.userEmail}"
                                            data-jobtype="${request.jobType}"
                                            data-jobid="${request.jobId}">Reject</button>
                                </div>
                            `;
                            
                            requestsList.appendChild(requestItem);
                        });
                        
                        document.querySelectorAll('.approve-request').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                if (!hasAdminAccess()) {
                                    alert('Admin access required');
                                    return;
                                }
                                const requestId = e.target.dataset.requestid;
                                const userId = e.target.dataset.userid;
                                const userEmail = e.target.dataset.useremail;
                                const points = parseInt(e.target.dataset.points);
                                const jobType = e.target.dataset.jobtype;
                                const jobId = e.target.dataset.jobid;
                                const jobTitle = e.target.dataset.jobtitle;
                                
                                console.log("Approving request:", requestId);
                                approveJobRequest(requestId, userId, userEmail, points, jobType, jobId, jobTitle);
                            });
                        });
                        
                        document.querySelectorAll('.reject-request').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                if (!hasAdminAccess()) {
                                    alert('Admin access required');
                                    return;
                                }
                                const requestId = e.target.dataset.requestid;
                                const userId = e.target.dataset.userid;
                                const userEmail = e.target.dataset.useremail;
                                const jobType = e.target.dataset.jobtype;
                                const jobId = e.target.dataset.jobid;
                                
                                console.log("Rejecting request:", requestId);
                                rejectJobRequest(requestId, userId, userEmail, jobType, jobId);
                            });
                        });
                    }
                    
                    hideLoading();
                })
                .catch((error) => {
                    console.error("Error loading job requests:", error);
                    document.getElementById('job-requests-list').innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading requests: ' + error.message + '</p></div>';
                    hideLoading();
                });
        }

        function approveJobRequest(requestId, userId, userEmail, points, jobType, jobId, jobTitle) {
            if (!confirm(`Approve this job and award ${points} Respect Points to ${userEmail}?`)) return;
            
            showLoading();
            
            const adminName = currentAdminUser.email;
            
            console.log("✅ Starting approval process for request:", requestId);
            
            const pointsHistoryData = {
                pointsAdded: points,
                reason: `Completed: ${jobTitle || jobType}`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                addedBy: adminName,
                customerEmail: userEmail,
                customerId: userId,
                jobId: jobId,
                jobType: jobType
            };
            
            const updates = {};
            
            const pointsHistoryId = 'ph_' + Date.now();
            updates['pointsHistory/' + pointsHistoryId] = pointsHistoryData;
            
            updates['jobRequests/' + requestId + '/status'] = 'approved';
            updates['jobRequests/' + requestId + '/processedBy'] = adminName;
            updates['jobRequests/' + requestId + '/processedAt'] = firebase.database.ServerValue.TIMESTAMP;
            updates['jobRequests/' + requestId + '/pointsAwarded'] = points;
            
            if (jobType === 'available_job' && jobId) {
                updates['users/' + userId + '/completedAvailableJobs/' + jobId] = {
                    status: 'approved',
                    processedAt: firebase.database.ServerValue.TIMESTAMP,
                    pointsAwarded: points
                };
            } else {
                updates['users/' + userId + '/completedJobs/' + jobId] = {
                    status: 'approved',
                    processedAt: firebase.database.ServerValue.TIMESTAMP,
                    pointsAwarded: points
                };
            }
            
            database.ref().update(updates)
                .then(() => {
                    console.log("✅ Job approved and points history updated");
                    
                    const notificationId = 'notification_' + Date.now();
                    const notificationData = {
                        userId: userId,
                        userEmail: userEmail,
                        type: 'job_approved',
                        title: 'Job Approved! 🎉',
                        message: `Your job "${jobTitle || jobType}" has been approved! You earned ${points} Respect Points.`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        read: false
                    };
                    
                    return database.ref('notifications/' + userId + '/' + notificationId).set(notificationData);
                })
                .then(() => {
                    createAdminNotification(`Job approved for ${userEmail}: ${jobTitle} (${points} points)`, 'job_approved');
                    
                    hideLoading();
                    alert(`✅ Job approved! ${points} Respect Points awarded to ${userEmail}.`);
                    console.log("✅ Approval process completed successfully");
                    
                    loadJobRequests();
                    generateRankings();
                })
                .catch((error) => {
                    hideLoading();
                    console.error('❌ Error approving job request:', error);
                    alert('❌ Error approving job: ' + error.message);
                });
        }

        function rejectJobRequest(requestId, userId, userEmail, jobType, jobId) {
            if (!confirm('Reject this job request?')) return;
            
            showLoading();
            
            const adminName = currentAdminUser.email;
            
            console.log("Starting rejection process for request:", requestId);
            
            database.ref('jobRequests/' + requestId).update({
                status: 'rejected',
                processedBy: adminName,
                processedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                console.log("Job request status updated to rejected");
                
                const notificationId = 'notification_' + Date.now();
                const jobTitle = document.querySelector(`[data-requestid="${requestId}"]`)?.dataset?.jobtitle || jobType;
                const notificationData = {
                    userId: userId,
                    userEmail: userEmail,
                    type: 'job_rejected',
                    title: 'Job Rejected',
                    message: `Your job "${jobTitle}" was rejected. Please ensure you completed all requirements properly.`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                };
                
                return database.ref('notifications/' + userId + '/' + notificationId).set(notificationData);
            })
            .then(() => {
                createAdminNotification(`Job rejected for ${userEmail}: ${jobTitle}`, 'job_rejected');
                
                hideLoading();
                alert('❌ Job rejected! User has been notified.');
                console.log("Rejection process completed successfully");
                
                loadJobRequests();
            })
            .catch((error) => {
                hideLoading();
                console.error('Error rejecting job request:', error);
                alert('❌ Error rejecting job: ' + error.message);
            });
        }

        function loadVaultRequests() {
            if (!hasAdminAccess()) {
                alert('Admin access required');
                return;
            }
            
            showLoading();
            
            database.ref('vaultRequests').orderByChild('timestamp').once('value')
                .then((snapshot) => {
                    const vaultRequestsList = document.getElementById('vault-requests-list');
                    vaultRequestsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        vaultRequestsList.innerHTML = '<div class="empty-state"><div>🔒</div><p>No vault requests</p></div>';
                        hideLoading();
                        return;
                    }
                    
                    const requests = [];
                    
                    snapshot.forEach(requestSnapshot => {
                        const request = requestSnapshot.val();
                        request.id = requestSnapshot.key;
                        if (request.status === 'new' || request.status === 'processing') {
                            requests.push(request);
                        }
                    });
                    
                    requests.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (requests.length === 0) {
                        vaultRequestsList.innerHTML = '<div class="empty-state"><div>🔒</div><p>No vault requests</p></div>';
                    } else {
                        requests.forEach(request => {
                            const requestItem = document.createElement('div');
                            requestItem.className = 'vault-request-item';
                            
                            const date = new Date(request.timestamp).toLocaleString();
                            const urgencyClass = request.urgency === 'urgent' || request.urgency === 'asap' ? 'urgent' : '';
                            
                            requestItem.innerHTML = `
                                <div class="vault-header">
                                    <span class="vault-service">${request.serviceType}</span>
                                    <span class="vault-urgency ${urgencyClass}">${request.urgency.toUpperCase()}</span>
                                </div>
                                <div class="vault-details">
                                    <div class="vault-user">User: ${request.userEmail}</div>
                                    <div class="vault-content">${request.serviceDetails}</div>
                                    <div class="vault-contact">Contact via: ${request.contactPreference}</div>
                                    <div class="request-date">Submitted: ${date}</div>
                                    <div class="request-status">Status: ${request.status}</div>
                                </div>
                                <div class="vault-actions">
                                    <button class="btn btn-success process-request" data-requestid="${request.id}">Mark as Processed</button>
                                    <button class="btn btn-danger delete-request" data-requestid="${request.id}">Delete</button>
                                </div>
                            `;
                            
                            vaultRequestsList.appendChild(requestItem);
                        });
                    }
                    
                    document.querySelectorAll('.process-request').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            if (!hasAdminAccess()) {
                                alert('Admin access required');
                                return;
                            }
                            const requestId = e.target.dataset.requestid;
                            processVaultRequest(requestId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-request').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            if (!hasAdminAccess()) {
                                alert('Admin access required');
                                return;
                            }
                            const requestId = e.target.dataset.requestid;
                            deleteVaultRequest(requestId);
                        });
                    });
                    
                    hideLoading();
                })
                .catch((error) => {
                    document.getElementById('vault-requests-list').innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading vault requests</p></div>';
                    hideLoading();
                });
        }

        function processVaultRequest(requestId) {
            showLoading();
            
            const adminName = currentAdminUser.email;
            
            database.ref('vaultRequests/' + requestId).once('value')
                .then((snapshot) => {
                    const requestData = snapshot.val();
                    return database.ref('vaultRequests/' + requestId).update({
                        status: 'processed',
                        processedBy: adminName,
                        processedAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => requestData);
                })
                .then((requestData) => {
                    createAdminNotification(`Vault request processed for ${requestData.userEmail}: ${requestData.serviceType}`, 'vault_processed');
                    
                    hideLoading();
                    alert('Request marked as processed!');
                    loadVaultRequests();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error updating request. Please try again.');
                });
        }

        function deleteVaultRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request?')) return;
            
            showLoading();
            
            database.ref('vaultRequests/' + requestId).remove()
                .then(() => {
                    hideLoading();
                    alert('Request deleted!');
                    loadVaultRequests();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Error deleting request. Please try again.');
                });
        }

        // =============================================
        // USER MANAGEMENT FUNCTIONS
        // =============================================
        
        let currentEditingUser = null;
        let originalUserEmail = null;

        function loadUserManagement() {
            loadUserStats();
            loadAllUsers();
        }

        function loadUserStats() {
            const userStats = document.getElementById('user-stats');
            userStats.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            database.ref('users').once('value')
                .then((snapshot) => {
                    let totalUsers = 0;
                    let customers = 0;
                    let admins = 0;
                    let activeUsers = 0;
                    let totalPoints = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const userData = userSnapshot.val();
                            totalUsers++;
                            totalPoints += userData.points || 0;
                            
                            if (userData.role === 'customer') {
                                customers++;
                            } else if (userData.role === 'admin') {
                                admins++;
                            }
                            
                            if (userData.status !== 'inactive' && userData.status !== 'suspended') {
                                activeUsers++;
                            }
                        });
                    }

                    userStats.innerHTML = `
                        <div class="user-stat-card">
                            <div class="user-stat-value">${totalUsers}</div>
                            <div class="user-stat-label">Total Users</div>
                        </div>
                        <div class="user-stat-card">
                            <div class="user-stat-value">${customers}</div>
                            <div class="user-stat-label">Customers</div>
                        </div>
                        <div class="user-stat-card">
                            <div class="user-stat-value">${admins}</div>
                            <div class="user-stat-label">Admins</div>
                        </div>
                        <div class="user-stat-card">
                            <div class="user-stat-value">${activeUsers}</div>
                            <div class="user-stat-label">Active Users</div>
                        </div>
                        <div class="user-stat-card">
                            <div class="user-stat-value">${totalPoints}</div>
                            <div class="user-stat-label">Total Points</div>
                        </div>
                    `;
                })
                .catch((error) => {
                    userStats.innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading user stats</p></div>';
                });
        }

        function searchUser() {
            const searchTerm = document.getElementById('search-user-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                alert('Please enter search term');
                return;
            }
            
            showLoading();
            
            database.ref('users').once('value')
                .then((snapshot) => {
                    const users = [];
                    snapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        userData.id = userSnapshot.key;
                        
                        // Search in email, name, phone
                        if (userData.email && userData.email.toLowerCase().includes(searchTerm) ||
                            userData.name && userData.name.toLowerCase().includes(searchTerm) ||
                            userData.phone && userData.phone.includes(searchTerm)) {
                            users.push(userData);
                        }
                    });
                    
                    displayUsersList(users);
                    hideLoading();
                })
                .catch((error) => {
                    console.error('Search error:', error);
                    hideLoading();
                    alert('Search failed: ' + error.message);
                });
        }

        function loadAllUsers() {
            showLoading();
            
            database.ref('users').once('value')
                .then((snapshot) => {
                    const users = [];
                    snapshot.forEach(userSnapshot => {
                        const userData = userSnapshot.val();
                        userData.id = userSnapshot.key;
                        users.push(userData);
                    });
                    
                    displayUsersList(users);
                    hideLoading();
                })
                .catch((error) => {
                    console.error('Load users error:', error);
                    hideLoading();
                    alert('Failed to load users: ' + error.message);
                });
        }

        function displayUsersList(users) {
            const container = document.getElementById('users-list-container');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>👥</div><p>No users found</p></div>';
                return;
            }
            
            let html = `
                <div style="margin-bottom: 1rem; color: #d4af37;">
                    Found ${users.length} users
                </div>
                <div style="display: grid; gap: 1rem;">
            `;
            
            users.forEach(user => {
                html += `
                    <div class="user-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="color: #d4af37; margin-bottom: 0.5rem;">${user.name || 'No Name'}</h4>
                                <div style="color: #ccc; font-size: 0.9rem;">
                                    <div>📧 ${user.email}</div>
                                    ${user.phone ? `<div>📞 ${user.phone}</div>` : ''}
                                    <div>⭐ ${user.points || 0} Points</div>
                                    <div>👤 ${user.role || 'customer'}</div>
                                    <div>🏠 ${getUserFamily(user.email)}</div>
                                    <div>📊 ${user.status || 'active'}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                <button onclick="editUser('${user.id}')" class="btn btn-primary" style="padding: 0.5rem 1rem;">Edit</button>
                                <button onclick="viewUserHistory('${user.id}', '${user.email}')" class="btn btn-info" style="padding: 0.5rem 1rem;">History</button>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #999;">
                            User ID: ${user.id}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getUserFamily(email) {
            const families = ["De Supreme Family", "De Speed Family", "De Reliable Family"];
            const emailHash = email.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return families[Math.abs(emailHash) % families.length];
        }

        function editUser(userId) {
            showLoading();
            
            database.ref('users/' + userId).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    currentEditingUser = userId;
                    originalUserEmail = userData.email;
                    
                    // Populate form
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-user-email').value = userData.email || '';
                    document.getElementById('edit-user-name').value = userData.name || '';
                    document.getElementById('edit-user-phone').value = userData.phone || '';
                    document.getElementById('edit-user-points').value = userData.points || 0;
                    document.getElementById('edit-user-role').value = userData.role || 'customer';
                    document.getElementById('edit-user-status').value = userData.status || 'active';
                    document.getElementById('edit-user-family').value = getUserFamily(userData.email);
                    
                    // Show form
                    document.getElementById('user-edit-form').style.display = 'block';
                    hideLoading();
                })
                .catch((error) => {
                    console.error('Error loading user:', error);
                    hideLoading();
                    alert('Failed to load user: ' + error.message);
                });
        }

        function updateUserDetails() {
            if (!currentEditingUser) return;
            
            const newEmail = document.getElementById('edit-user-email').value;
            
            if (newEmail !== originalUserEmail) {
                // Email changed - do migration
                generateMigrationReport(originalUserEmail, newEmail);
            } else {
                // Only other fields changed
                updateUserDetailsWithoutEmail();
            }
        }

        function updateUserDetailsWithoutEmail() {
            const updates = {
                name: document.getElementById('edit-user-name').value,
                phone: document.getElementById('edit-user-phone').value,
                points: parseInt(document.getElementById('edit-user-points').value) || 0,
                role: document.getElementById('edit-user-role').value,
                status: document.getElementById('edit-user-status').value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: auth.currentUser.uid
            };
            
            showLoading();
            
            database.ref('users/' + currentEditingUser).update(updates)
                .then(() => {
                    hideLoading();
                    alert('✅ User updated successfully!');
                    closeUserEdit();
                    loadAllUsers();
                    loadUserStats();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Update failed: ' + error.message);
                });
        }

        function generateMigrationReport(oldEmail, newEmail) {
            showLoading();
            
            const report = {
                oldEmail: oldEmail,
                newEmail: newEmail,
                timestamp: Date.now(),
                changes: {}
            };
            
            Promise.all([
                database.ref('orders').orderByChild('email').equalTo(oldEmail).once('value'),
                database.ref('orders').orderByChild('customerEmail').equalTo(oldEmail).once('value'),
                database.ref('pointsHistory').orderByChild('customerEmail').equalTo(oldEmail).once('value'),
                database.ref('redemptions').orderByChild('customerEmail').equalTo(oldEmail).once('value'),
                database.ref('jobRequests').orderByChild('userEmail').equalTo(oldEmail).once('value'),
                database.ref('vaultRequests').orderByChild('userEmail').equalTo(oldEmail).once('value'),
                database.ref('customers').orderByChild('email').equalTo(oldEmail).once('value'),
                database.ref('rankings').orderByChild('email').equalTo(oldEmail).once('value')
            ])
            .then(([orders1, orders2, points, redemptions, jobs, vault, customers, rankings]) => {
                report.changes.orders = orders1.numChildren() + orders2.numChildren();
                report.changes.pointsHistory = points.numChildren();
                report.changes.redemptions = redemptions.numChildren();
                report.changes.jobRequests = jobs.numChildren();
                report.changes.vaultRequests = vault.numChildren();
                report.changes.customers = customers.numChildren();
                report.changes.rankings = rankings.numChildren();
                
                hideLoading();
                
                const totalChanges = Object.values(report.changes).reduce((sum, count) => sum + count, 0);
                
                const proceed = confirm(`📊 MIGRATION REPORT:\n\nEmail: ${oldEmail} → ${newEmail}\n\nRecords to update:\n• Orders: ${report.changes.orders}\n• Points History: ${report.changes.pointsHistory}\n• Redemptions: ${report.changes.redemptions}\n• Job Requests: ${report.changes.jobRequests}\n• Vault Requests: ${report.changes.vaultRequests}\n• Customer Records: ${report.changes.customers}\n• Rankings: ${report.changes.rankings}\n\nTOTAL: ${totalChanges} records\n\nProceed with migration?`);
                
                if (proceed) {
                    migrateUserEmail(oldEmail, newEmail);
                }
            })
            .catch((error) => {
                hideLoading();
                alert('Migration report failed: ' + error.message);
            });
        }

        function migrateUserEmail(oldEmail, newEmail) {
            showLoading();
            
            const updates = {};
            const timestamp = firebase.database.ServerValue.TIMESTAMP;
            
            // 1. Update user profile
            updates[`users/${currentEditingUser}/email`] = newEmail;
            updates[`users/${currentEditingUser}/updatedAt`] = timestamp;
            updates[`users/${currentEditingUser}/emailHistory`] = {
                [Date.now()]: {
                    from: oldEmail,
                    to: newEmail,
                    changedBy: auth.currentUser.uid,
                    timestamp: timestamp
                }
            };
            
            // 2. Update all orders
            return database.ref('orders').orderByChild('email').equalTo(oldEmail).once('value')
                .then((ordersSnapshot) => {
                    if (ordersSnapshot.exists()) {
                        ordersSnapshot.forEach(orderSnapshot => {
                            updates[`orders/${orderSnapshot.key}/email`] = newEmail;
                            updates[`orders/${orderSnapshot.key}/customerEmail`] = newEmail;
                            updates[`orders/${orderSnapshot.key}/updatedAt`] = timestamp;
                        });
                    }
                    return database.ref('orders').orderByChild('customerEmail').equalTo(oldEmail).once('value');
                })
                .then((customerOrdersSnapshot) => {
                    if (customerOrdersSnapshot.exists()) {
                        customerOrdersSnapshot.forEach(orderSnapshot => {
                            updates[`orders/${orderSnapshot.key}/customerEmail`] = newEmail;
                            updates[`orders/${orderSnapshot.key}/updatedAt`] = timestamp;
                        });
                    }
                    
                    // 3. Update points history
                    return database.ref('pointsHistory').orderByChild('customerEmail').equalTo(oldEmail).once('value');
                })
                .then((pointsSnapshot) => {
                    if (pointsSnapshot.exists()) {
                        pointsSnapshot.forEach(pointSnapshot => {
                            updates[`pointsHistory/${pointSnapshot.key}/customerEmail`] = newEmail;
                        });
                    }
                    
                    // 4. Update redemptions
                    return database.ref('redemptions').orderByChild('customerEmail').equalTo(oldEmail).once('value');
                })
                .then((redemptionsSnapshot) => {
                    if (redemptionsSnapshot.exists()) {
                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                            updates[`redemptions/${redemptionSnapshot.key}/customerEmail`] = newEmail;
                        });
                    }
                    
                    // 5. Update job requests
                    return database.ref('jobRequests').orderByChild('userEmail').equalTo(oldEmail).once('value');
                })
                .then((jobsSnapshot) => {
                    if (jobsSnapshot.exists()) {
                        jobsSnapshot.forEach(jobSnapshot => {
                            updates[`jobRequests/${jobSnapshot.key}/userEmail`] = newEmail;
                        });
                    }
                    
                    // 6. Update vault requests
                    return database.ref('vaultRequests').orderByChild('userEmail').equalTo(oldEmail).once('value');
                })
                .then((vaultSnapshot) => {
                    if (vaultSnapshot.exists()) {
                        vaultSnapshot.forEach(vaultSnapshot => {
                            updates[`vaultRequests/${vaultSnapshot.key}/userEmail`] = newEmail;
                        });
                    }
                    
                    // 7. Update customers collection
                    return database.ref('customers').orderByChild('email').equalTo(oldEmail).once('value');
                })
                .then((customersSnapshot) => {
                    if (customersSnapshot.exists()) {
                        customersSnapshot.forEach(customerSnapshot => {
                            updates[`customers/${customerSnapshot.key}/email`] = newEmail;
                        });
                    }
                    
                    // 8. Update rankings
                    return database.ref('rankings').orderByChild('email').equalTo(oldEmail).once('value');
                })
                .then((rankingsSnapshot) => {
                    if (rankingsSnapshot.exists()) {
                        rankingsSnapshot.forEach(rankingSnapshot => {
                            updates[`rankings/${rankingSnapshot.key}/email`] = newEmail;
                        });
                    }
                    
                    // 9. Apply ALL updates at once
                    console.log('🔄 Applying updates to', Object.keys(updates).length, 'paths');
                    return database.ref().update(updates);
                })
                .then(() => {
                    hideLoading();
                    alert('✅ Email migrated successfully! All records updated.');
                    closeUserEdit();
                    loadAllUsers();
                    loadUserStats();
                    createAdminNotification(`Email migrated: ${oldEmail} → ${newEmail}`, 'user_management');
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Migration error:', error);
                    alert('Migration failed: ' + error.message);
                });
        }

        function resetPassword() {
            if (!currentEditingUser) return;
            
            const userEmail = document.getElementById('edit-user-email').value;
            
            // Note: This requires Firebase Auth admin privileges
            // For client-side, we can only send a reset email
            auth.sendPasswordResetEmail(userEmail)
                .then(() => {
                    alert('📧 Password reset email sent to user');
                    createAdminNotification(`Password reset sent to: ${userEmail}`, 'user_management');
                })
                .catch((error) => {
                    console.error('Password reset error:', error);
                    alert('Password reset failed: ' + error.message);
                });
        }

        function deleteUser() {
            if (!currentEditingUser) return;
            
            const userEmail = document.getElementById('edit-user-email').value;
            
            if (!confirm(`⚠️ DELETE USER?\n\nThis will permanently delete ${userEmail} from the database.\n\nThis action cannot be undone!`)) {
                return;
            }
            
            showLoading();
            
            database.ref('users/' + currentEditingUser).remove()
                .then(() => {
                    hideLoading();
                    alert('✅ User deleted successfully!');
                    closeUserEdit();
                    loadAllUsers();
                    loadUserStats();
                    createAdminNotification(`User deleted: ${userEmail}`, 'user_management');
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Delete error:', error);
                    alert('Delete failed: ' + error.message);
                });
        }

        function closeUserEdit() {
            document.getElementById('user-edit-form').style.display = 'none';
            currentEditingUser = null;
            originalUserEmail = null;
        }

        function viewUserHistory(userId, userEmail) {
            alert(`View history for: ${userEmail}\n\nThis would open a detailed history view in a future update.`);
        }

        function exportUserData() {
            showLoading();
            
            database.ref('users').once('value')
                .then((snapshot) => {
                    const users = [];
                    snapshot.forEach(userSnapshot => {
                        users.push({
                            id: userSnapshot.key,
                            ...userSnapshot.val()
                        });
                    });
                    
                    // Create CSV
                    let csv = 'ID,Name,Email,Phone,Points,Role,Family,Status,Created\n';
                    users.forEach(user => {
                        const created = user.createdAt ? new Date(user.createdAt).toISOString().split('T')[0] : 'Unknown';
                        csv += `"${user.id}","${user.name || ''}","${user.email || ''}","${user.phone || ''}",${user.points || 0},"${user.role || 'customer'}","${getUserFamily(user.email)}","${user.status || 'active'}","${created}"\n`;
                    });
                    
                    // Download
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    hideLoading();
                    createAdminNotification('User data exported to CSV', 'data_export');
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Export error:', error);
                    alert('Export failed: ' + error.message);
                });
        }

        function generateMigrationReportForAll() {
            showLoading();
            
            database.ref('users').once('value')
                .then((snapshot) => {
                    let report = 'EMAIL MIGRATION REPORT\n\n';
                    report += 'User Count: ' + snapshot.numChildren() + '\n\n';
                    
                    snapshot.forEach(userSnapshot => {
                        const user = userSnapshot.val();
                        report += `User: ${user.name || 'No Name'} (${user.email})\n`;
                        report += `Family: ${getUserFamily(user.email)}\n`;
                        report += `Points: ${user.points || 0}\n`;
                        report += `Status: ${user.status || 'active'}\n`;
                        report += '─'.repeat(50) + '\n';
                    });
                    
                    // Download report
                    const blob = new Blob([report], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `migration-report-${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    hideLoading();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Report generation failed: ' + error.message);
                });
        }

        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener for notification user type change
            document.getElementById('notification-user').addEventListener('change', function() {
                const specificGroup = document.getElementById('specific-user-group');
                if (this.value === 'specific') {
                    specificGroup.style.display = 'block';
                } else {
                    specificGroup.style.display = 'none';
                }
            });

            // Rivalry tab management
            document.querySelectorAll('.rivalry-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.rivalry-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.rivalry-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // Load specific content when tab is clicked
                    if (tabName === 'stats') {
                        loadWarStatistics();
                    }
                    if (tabName === 'weekly-bonuses') {
                        loadWeeklyBonuses();
                    }
                });
            });

            auth.onAuthStateChanged((user) => {
                if (user) {
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (userData && userData.role === 'admin') {
                                currentAdminUser = { ...userData, uid: user.uid };
                                showPage('admin-dashboard');
                                initAdminDashboard();
                            } else {
                                showPage('admin-login-page');
                                currentAdminUser = null;
                            }
                        })
                        .catch((error) => {
                            console.error('Error checking admin access:', error);
                            showPage('admin-login-page');
                            currentAdminUser = null;
                        });
                } else {
                    showPage('admin-login-page');
                    currentAdminUser = null;
                }
            });
            
            document.getElementById('admin-login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const errorElement = document.getElementById('admin-error-message');
                
                errorElement.textContent = 'Logging in...';
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const userId = userCredential.user.uid;
                        return database.ref('users/' + userId).once('value');
                    })
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        
                        if (!userData) {
                            throw new Error("User data not found in database");
                        }
                        if (userData.role !== 'admin') {
                            throw new Error("You don't have admin privileges");
                        }
                        
                        currentAdminUser = { ...userData, uid: snapshot.key };
                        errorElement.textContent = 'Login successful!';
                        errorElement.className = 'success-message';
                        
                        setTimeout(() => {
                            showPage('admin-dashboard');
                            initAdminDashboard();
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error("Login error:", error);
                        errorElement.textContent = error.message;
                        errorElement.className = 'error-message';
                        currentAdminUser = null;
                    });
            });
            
            document.getElementById('admin-logout-btn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    showPage('admin-login-page');
                    currentAdminUser = null;
                });
            });

            document.getElementById('back-to-overview').addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector('[data-tab="rankings"]').classList.add('active');
                document.getElementById('rankings-tab').classList.add('active');
                
                loadRankings();
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (!hasAdminAccess()) {
                        alert('Admin access required');
                        return;
                    }
                    
                    const tabName = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    if (tabName === 'rankings') {
                        loadRankings();
                    } else if (tabName === 'jobs') {
                        loadAvailableJobs();
                    } else if (tabName === 'requests') {
                        loadJobRequests();
                    } else if (tabName === 'vault') {
                        loadVaultRequests();
                    } else if (tabName === 'users') {
                        loadUserManagement();
                    } else if (tabName === 'rivalry') {
                        showRivalryManagement();
                    } else if (tabName === 'notifications') {
                        loadAdminNotifications();
                    }
                });
            });
            
            document.getElementById('add-job-form').addEventListener('submit', function(e) {
                e.preventDefault();
                if (!hasAdminAccess()) {
                    alert('Admin access required to create jobs');
                    return;
                }
                addNewJob();
            });
        });
        
        function initAdminDashboard() {
            if (!hasAdminAccess()) {
                alert('Admin access required');
                auth.signOut();
                return;
            }
            loadRankings();
            createAdminNotification(`Admin logged in: ${currentAdminUser.email}`, 'system');
        }
    </script>
</body>
</html>