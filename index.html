<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaundryPro Management System</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Auth Pages */
        .auth-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
        }
        
        .auth-container h2 {
            text-align: center;
            color: #2196F3;
            margin-bottom: 20px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
        }
        
        .auth-form input {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .auth-form button {
            background-color: #2196F3;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .auth-form button:hover {
            background-color: #0d8bf2;
        }
        
        .error-message {
            color: #f44336;
            margin-bottom: 15px;
            text-align: center;
            min-height: 20px;
        }
        
        .success-message {
            color: green;
        }
        
        .login-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .login-btn {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .admin-btn {
            background: #f44336;
        }
        
        /* Admin Dashboard Styles */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 5rem auto 2rem;
            padding: 0 1rem;
            min-height: 1200px;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-info {
            background-color: #1abc9c;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .search-container {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 1rem;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 4rem;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
        }
        
        .status-pending {
            color: #f39c12;
            font-weight: 500;
        }
        
        .status-ready {
            color: #2ecc71;
            font-weight: 500;
        }
        
        .status-collected {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .points-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .points-earned-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .points-balance-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            background-color: #9b59b6;
            color: white;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .add-points-btn {
            background-color: #9b59b6;
            color: white;
        }
        
        .redeem-btn {
            background-color: #e67e22;
            color: white;
        }
        
        .history-btn {
            background-color: #95a5a6;
            color: white;
        }
        
        .redeemed-points {
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* Customer Profile Styles */
        .profile-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
        }
        
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        
        .profile-details div {
            margin-bottom: 1rem;
        }
        
        .profile-details strong {
            display: inline-block;
            width: 120px;
            color: #2c3e50;
        }
        
        .points-display {
            background-color: #9b59b6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }
        
        .customer-service {
            text-align: center;
            padding: 1rem;
            background-color: #2c3e50;
            color: white;
            margin-top: 2rem;
        }
        
        .call-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: #2ecc71;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 0.5rem;
            transition: background-color 0.3s;
        }
        
        .call-btn:hover {
            background-color: #27ae60;
        }
        
        /* Page Visibility */
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        /* Add Points Modal */
        #points-modal .modal-content {
            max-width: 400px;
            z-index: 2100;
        }
        
        /* Redeem Points Modal */
        #redeem-modal .modal-content {
            max-width: 400px;
            z-index: 2100;
        }
        
        /* History Modal */
        .history-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .history-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 0.5rem;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .history-date {
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .history-action {
            margin: 0.5rem 0;
            color: #2c3e50;
        }
        
        .history-details {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .points-added {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .points-redeemed {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .visits-badge {
            background-color: #3498db;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 1rem;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .summary-item {
            text-align: center;
            padding: 0 1rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        /* New styles for history page buttons */
        .history-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .history-btn-large {
            padding: 10px 20px;
            font-size: 1rem;
        }
        
        /* Customer History Section */
        .customer-history-section {
            margin-top: 2rem;
        }
        
        .customer-history-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .customer-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .customer-history-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .customer-history-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
        }
        
        .customer-history-details strong {
            color: #2c3e50;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 0.25rem;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Mobile back button for customer history tab */
        .mobile-back-btn {
            display: none;
            padding: 0.5rem 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        /* Points Portal Styles */
        .points-portal-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
        }
        
        .points-portal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin: -2rem -2rem 2rem -2rem;
        }
        
        .points-display-large {
            font-size: 42px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .points-label {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item-portal {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item-portal:hover {
            background: #f8f9fa;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-date-portal {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .history-desc {
            font-weight: 500;
            margin: 5px 0;
        }
        
        .history-details-portal {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .points-change {
            font-weight: bold;
            font-size: 18px;
        }
        
        .points-added {
            color: #27ae60;
        }
        
        .points-redeemed {
            color: #e74c3c;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .back-to-dashboard {
            margin-top: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .mobile-back-btn {
                display: block;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .customer-history-content {
                grid-template-columns: 1fr;
            }
            
            .history-item-portal {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .points-change {
                margin-top: 10px;
                align-self: flex-end;
            }
            
            .history-filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Selection Page -->
    <div id="selection-page" class="page active">
        <div class="container">
            <div class="auth-container">
                <h1>Welcome to LaundryPro</h1>
                <p>Please select your login type:</p>
                <div class="login-options">
                    <button class="login-btn" onclick="showLogin('customer')">Customer Login</button>
                    <button class="login-btn admin-btn" onclick="showLogin('admin')">Admin Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Login Form -->
    <div id="customer-login" class="page">
        <div class="container">
            <div class="auth-container">
                <h2>Customer Login</h2>
                <div id="customer-error-message" class="error-message"></div>
                
                <form id="customer-login-form" class="auth-form">
                    <input type="email" id="customer-email" placeholder="Email" required>
                    <input type="password" id="customer-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <button class="btn btn-warning" onclick="showSelection()" style="width: 100%;">Back</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Form -->
    <div id="admin-login" class="page">
        <div class="container">
            <div class="auth-container">
                <h2>Admin Login</h2>
                <div id="admin-error-message" class="error-message"></div>
                
                <form id="admin-login-form" class="auth-form">
                    <input type="email" id="admin-email" placeholder="Admin Email" required>
                    <input type="password" id="admin-password" placeholder="Admin Password" required>
                    <button type="submit">Login</button>
                </form>
                <button class="btn btn-warning" onclick="showSelection()" style="width: 100%;">Back</button>
            </div>
        </div>
    </div>

    <!-- Customer Landing Page -->
    <div id="customer-landing" class="page">
        <header>
            <h1>My Supreme Profile</h1>
            <button id="customer-logout-btn" class="btn btn-danger">Logout</button>
        </header>
        
        <div class="container">
            <div class="profile-card">
                <div class="profile-header">
                    <h2 id="customer-name">Loading...</h2>
                    <div class="points-display" id="total-points">0 points</div>
                </div>
                
                <div class="profile-details">
                    <h3>My Details</h3>
                    <div><strong>Email:</strong> <span id="customer-email-display">Loading...</span></div>
                    <div><strong>Phone:</strong> <span id="customer-phone">Loading...</span></div>
                    <div><strong>Member Since:</strong> <span id="customer-since">Loading...</span></div>
                </div>
                
                <div class="orders">
                    <h3>My Laundry Orders</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Status</th>
                                <th>Loyalty Points</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="view-points-btn" class="btn btn-primary">View My Points Portal</button>
                </div>
            </div>
        </div>

        <div class="customer-service">
            <p>Need help? Contact our customer service</p>
            <a href="tel:09043930196" class="call-btn">Call De Supreme Customer Service</a>
        </div>
    </div>

    <!-- Customer Points Portal -->
    <div id="customer-points-portal" class="page">
        <header>
            <h1>My Laundry Points Portal</h1>
            <button id="points-portal-back-btn" class="btn btn-warning">Back to Dashboard</button>
            <button id="points-portal-logout-btn" class="btn btn-danger">Logout</button>
        </header>
        
        <div class="container">
            <div class="points-portal-container">
                <div class="points-portal-header">
                    <h2 id="points-customer-name">Customer Name</h2>
                    <div class="points-display-large" id="points-balance">0</div>
                    <div class="points-label">Loyalty Points</div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <span class="detail-label">Email Address</span>
                        <span id="points-customer-email">loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Phone Number</span>
                        <span id="points-customer-phone">loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member Since</span>
                        <span id="points-member-since">loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Points Earned</span>
                        <span id="points-total-earned" class="points-added">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Points Redeemed</span>
                        <span id="points-total-redeemed" class="points-redeemed">0</span>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3>Points History</h3>
                    
                    <div class="history-filters">
                        <button class="filter-btn active" data-filter="all">All Activity</button>
                        <button class="filter-btn" data-filter="earned">Points Earned</button>
                        <button class="filter-btn" data-filter="redeemed">Points Redeemed</button>
                    </div>
                    
                    <div class="history-list" id="points-history-list">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <div class="back-to-dashboard">
                    <button id="back-to-dashboard-btn" class="btn btn-primary">Back to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Landing Page -->
    <div id="admin-landing" class="page">
        <header>
            <h1>De Supreme Laundry House Admin</h1>
            <button id="admin-logout-btn" class="btn btn-danger">Logout</button>
        </header>
        
        <div class="admin-container">
            <div class="tabs">
                <div class="tab active" data-tab="orders">Orders</div>
                <div class="tab" data-tab="customers">Customer History</div>
            </div>
            
            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content active">
                <div class="btn-group">
                    <button id="add-customer-btn" class="btn btn-primary">Add New Customer</button>
                </div>
                
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Search by name, phone, email, items, or status...">
                    <button id="clear-search-btn" class="btn btn-warning">Clear</button>
                </div>
                
                <table id="customers-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Items</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Loyalty Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-list">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 2rem;">Loading customers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Customer History Tab Content -->
            <div id="customers-tab" class="tab-content">
                <button class="mobile-back-btn" id="mobile-back-btn">← Back to Orders</button>
                <div class="search-container">
                    <input type="text" id="customer-search-input" class="search-input" placeholder="Search customers by name, phone, or email...">
                    <button id="clear-customer-search-btn" class="btn btn-warning">Clear</button>
                </div>
                
                <div class="customer-history-section" id="customer-history-list">
                    <p>Loading customer history...</p>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Customer Modal -->
        <div class="modal" id="customer-modal">
            <div class="modal-content">
                <button id="close-modal" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                <h2 id="modal-title">Add New Customer</h2>
                <form id="customer-form">
                    <input type="hidden" id="customer-id">
                    
                    <div class="form-group">
                        <label for="customer-name-input" class="form-label">Name:</label>
                        <input type="text" id="customer-name-input" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-phone-input" class="form-label">Phone:</label>
                        <input type="tel" id="customer-phone-input" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-email-input" class="form-label">Email:</label>
                        <input type="email" id="customer-email-input" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-items-input" class="form-label">Items:</label>
                        <input type="text" id="customer-items-input" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-date-input" class="form-label">Date:</label>
                        <input type="date" id="customer-date-input" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-status-input" class="form-label">Status:</label>
                        <select id="customer-status-input" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="ready">Ready</option>
                            <option value="collected">Collected</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-points-input" class="form-label">Loyalty Points:</label>
                        <input type="number" id="customer-points-input" class="form-control" value="0" min="0">
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">Save Customer</button>
                </form>
            </div>
        </div>
        
        <!-- Add Points Modal -->
        <div class="modal" id="points-modal">
            <div class="modal-content">
                <button id="close-points-modal" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                <h2>Add Points</h2>
                <form id="points-form">
                    <input type="hidden" id="points-customer-id">
                    <div class="form-group">
                        <label for="points-amount" class="form-label">Points to Add:</label>
                        <input type="number" id="points-amount" class="form-control" value="10" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="points-reason" class="form-label">Reason (optional):</label>
                        <input type="text" id="points-reason" class="form-control" placeholder="e.g. Loyalty bonus, Referral, etc.">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Add Points</button>
                </form>
            </div>
        </div>
        
        <!-- Redeem Points Modal -->
        <div class="modal" id="redeem-modal">
            <div class="modal-content">
                <button id="close-redeem-modal" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                <h2>Redeem Points</h2>
                <form id="redeem-form">
                    <input type="hidden" id="redeem-customer-id">
                    <div class="form-group">
                        <label for="redeem-amount" class="form-label">Points to Redeem:</label>
                        <input type="number" id="redeem-amount" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="redeem-reason" class="form-label">Reward/Reason:</label>
                        <input type="text" id="redeem-reason" class="form-control" placeholder="e.g. Free Detergent, Discount, etc." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points Balance: <span id="points-balance-display">0</span></label>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Redeem Points</button>
                </form>
            </div>
        </div>
        
        <!-- Customer History Modal -->
        <div class="modal" id="history-modal">
            <div class="modal-content">
                <button id="close-history-modal" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                <h2 id="history-title">Customer History</h2>
                
                <div class="summary-card">
                    <div class="summary-item">
                        <div class="summary-value" id="total-visits">0</div>
                        <div class="summary-label">Total Visits</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-orders">0</div>
                        <div class="summary-label">Total Orders</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-points-earned">0</div>
                        <div class="summary-label">Points Earned</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-points-redeemed">0</div>
                        <div class="summary-label">Points Redeemed</div>
                    </div>
                </div>
                
                <div class="customer-details">
                    <h3>Customer Information</h3>
                    <div><strong>Name:</strong> <span id="history-customer-name">Loading...</span></div>
                    <div><strong>Phone:</strong> <span id="history-customer-phone">Loading...</span></div>
                    <div><strong>Email:</strong> <span id="history-customer-email">Loading...</span></div>
                    <div><strong>Total Points Earned:</strong> <span id="history-customer-points-earned" class="points-earned-badge">0</span></div>
                    <div><strong>Current Points Balance:</strong> <span id="history-customer-points-balance" class="points-balance-badge">0</span></div>
                </div>
                
                <div class="history-section">
                    <h3>Order History <span class="visits-badge" id="order-count">0 orders</span></h3>
                    <div id="order-history-list">
                        <p>Loading order history...</p>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3>Points History <span class="visits-badge" id="points-count">0 events</span></h3>
                    <div id="points-history-list">
                        <p>Loading points history...</p>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3>Redemption History <span class="visits-badge" id="redemption-count">0 redemptions</span></h3>
                    <div id="redemption-history-list">
                        <p>Loading redemption history...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div class="loading" id="loading-indicator">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-UKRcGQ6k_UekiBigQLmU9WR20UGazWg",
            authDomain: "desupreme-laundromat-store-mgt.firebaseapp.com",
            databaseURL: "https://desupreme-laundromat-store-mgt-default-rtdb.firebaseio.com",
            projectId: "desupreme-laundromat-store-mgt",
            storageBucket: "desupreme-laundromat-store-mgt.appspot.com",
            messagingSenderId: "635010254043",
            appId: "1:635010254043:web:81addf7247e261c8a538fe",
            measurementId: "G-0YDT6GEWZS"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const database = firebase.database();
        
        // Variables to store customers data
        let allCustomers = [];
        let allCustomerProfiles = [];
        let currentHistoryCustomerId = null;
        
        // Points portal variables
        let pointsHistory = [];
        let currentFilter = 'all';
        
        // Page navigation functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function showSelection() {
            showPage('selection-page');
        }
        
        function showLogin(type) {
            showPage(`${type}-login`);
        }
        
        function showCustomerLanding() {
            showPage('customer-landing');
            loadCustomerData();
        }
        
        function showCustomerPointsPortal() {
            showPage('customer-points-portal');
            loadPointsPortalData();
        }
        
        function showAdminLanding() {
            showPage('admin-landing');
            initAdminDashboard();
        }
        
        // Customer login handler
        document.getElementById('customer-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('customer-email').value;
            const password = document.getElementById('customer-password').value;
            const errorElement = document.getElementById('customer-error-message');
            
            errorElement.textContent = '';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Check if this is a customer account
                    return database.ref('users/' + userCredential.user.uid).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (userData && userData.role === 'customer') {
                                showCustomerLanding();
                            } else {
                                auth.signOut();
                                throw new Error('This account is not registered as a customer');
                            }
                        });
                })
                .catch((error) => {
                    errorElement.textContent = error.message;
                    console.error('Login error:', error);
                });
        });
        
        // Admin login handler
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('admin-error-message');
            
            errorElement.textContent = 'Logging in...';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Authentication successful, checking user role...");
                    const userId = userCredential.user.uid;
                    return database.ref('users/' + userId).once('value');
                })
                .then((snapshot) => {
                    const userData = snapshot.val();
                    console.log("User data:", userData);
                    
                    if (!userData) {
                        throw new Error("User data not found in database");
                    }
                    if (userData.role !== 'admin') {
                        throw new Error("You don't have admin privileges");
                    }
                    
                    errorElement.textContent = 'Login successful!';
                    errorElement.className = 'success-message';
                    
                    // Show admin dashboard after a brief delay
                    setTimeout(() => {
                        showAdminLanding();
                    }, 1000);
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    errorElement.textContent = error.message;
                    errorElement.className = 'error-message';
                    
                    // Special handling for admin credentials
                    if (email === "golden31joseph@gmail.com" && password === "Golden") {
                        errorElement.textContent += " (Admin account needs setup)";
                        createAdminAccount();
                    }
                    
                    auth.signOut();
                });
        });
        
        // Logout handlers
        document.getElementById('customer-logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                showSelection();
            });
        });
        
        document.getElementById('points-portal-logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                showSelection();
            });
        });
        
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                showSelection();
            });
        });
        
        // Points portal navigation
        document.getElementById('view-points-btn').addEventListener('click', () => {
            showCustomerPointsPortal();
        });
        
        document.getElementById('points-portal-back-btn').addEventListener('click', () => {
            showCustomerLanding();
        });
        
        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
            showCustomerLanding();
        });
        
        // Customer profile functions
        function loadCustomerData() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Load user profile data
            database.ref('users/' + user.uid).once('value')
                .then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData) {
                        document.getElementById('customer-name').textContent = userData.name || 'Customer';
                        document.getElementById('customer-email-display').textContent = userData.email || user.email;
                        document.getElementById('customer-phone').textContent = userData.phone || 'Not provided';
                        
                        if (userData.createdAt) {
                            const joinDate = new Date(userData.createdAt);
                            document.getElementById('customer-since').textContent = joinDate.toLocaleDateString();
                        }
                    }

                    // Load all customer orders
                    return database.ref('customers').orderByChild('email').equalTo(user.email).once('value');
                })
                .then((ordersSnapshot) => {
                    const ordersList = document.getElementById('orders-list');
                    ordersList.innerHTML = '';
                    
                    if (!ordersSnapshot.exists()) {
                        ordersList.innerHTML = '<tr><td colspan="4">No orders found</td></tr>';
                        updatePointsDisplay(0);
                        return;
                    }
                    
                    let totalPoints = 0;
                    let ordersArray = [];
                    
                    // Process each order
                    ordersSnapshot.forEach((orderSnapshot) => {
                        const order = orderSnapshot.val();
                        ordersArray.push(order);
                        
                        // Sum points from each order
                        const orderPoints = parseInt(order.points) || 0;
                        totalPoints += orderPoints;
                    });
                    
                    // Update points display
                    updatePointsDisplay(totalPoints);
                    
                    // Display orders sorted by date (newest first)
                    displayOrders(ordersArray);
                })
                .catch((error) => {
                    console.error('Error loading data:', error);
                });
        }

        function updatePointsDisplay(totalPoints) {
            document.getElementById('total-points').textContent = `${totalPoints} points`;
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('orders-list');
            
            // Sort orders by date (newest first)
            orders.sort((a, b) => {
                const dateA = a.date || a.createdAt || 0;
                const dateB = b.date || b.createdAt || 0;
                return new Date(dateB) - new Date(dateA);
            });
            
            // Create table rows
            orders.forEach(order => {
                const row = document.createElement('tr');
                
                const orderDate = order.date ? new Date(order.date).toLocaleDateString() : 
                               (order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A');
                
                let statusClass = 'status-pending';
                if (order.collected) statusClass = 'status-collected';
                else if (order.ready) statusClass = 'status-ready';
                
                const orderPoints = order.points || 0;
                
                row.innerHTML = `
                    <td>${orderDate}</td>
                    <td>${order.items || 'N/A'}</td>
                    <td class="${statusClass}">${getStatusText(order)}</td>
                    <td>${orderPoints}</td>
                `;
                
                ordersList.appendChild(row);
            });
        }

        function getStatusText(order) {
            if (order.collected) return 'Collected';
            if (order.ready) return 'Ready for pickup';
            return 'In progress';
        }
        
        // Points portal functions
        function loadPointsPortalData() {
            const user = auth.currentUser;
            if (!user) return;
            
            showPointsLoading();
            
            // Load user profile data
            database.ref('users/' + user.uid).once('value')
                .then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    if (userData) {
                        document.getElementById('points-customer-name').textContent = userData.name || 'Customer';
                        document.getElementById('points-customer-email').textContent = userData.email || user.email;
                        document.getElementById('points-customer-phone').textContent = userData.phone || 'Not provided';
                        
                        if (userData.createdAt) {
                            const joinDate = new Date(userData.createdAt);
                            document.getElementById('points-member-since').textContent = joinDate.toLocaleDateString();
                        }
                    }

                    // Load points data
                    return loadPointsData(user);
                })
                .catch((error) => {
                    console.error('Error loading points data:', error);
                    document.getElementById('points-history-list').innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading your data</p></div>';
                });
        }
        
        function loadPointsData(user) {
            if (!user) return;
            
            pointsHistory = [];
            let totalBalance = 0;
            let totalEarned = 0;
            let totalRedeemed = 0;
            
            // Get customer data using email query
            database.ref('customers').orderByChild('email').equalTo(user.email).once('value')
                .then(customersSnapshot => {
                    if (!customersSnapshot.exists()) {
                        throw new Error('No customer record found for your email');
                    }
                    
                    const promises = [];
                    const seenItems = new Set(); // Track seen items to prevent duplicates
                    
                    // Process each customer record (each order)
                    customersSnapshot.forEach(customerSnapshot => {
                        const customerData = customerSnapshot.val();
                        const customerId = customerSnapshot.key;
                        
                        // Get points from this order
                        const orderPoints = parseInt(customerData.points) || 0;
                        
                        // Add order points to earned total
                        totalEarned += orderPoints;
                        
                        // Add order to points history
                        if (orderPoints > 0) {
                            const orderKey = `order-${customerId}`;
                            
                            // Skip if we've already processed this order
                            if (!seenItems.has(orderKey)) {
                                seenItems.add(orderKey);
                                
                                pointsHistory.push({
                                    type: 'earned',
                                    date: customerData.date || customerData.createdAt || Date.now(),
                                    description: 'Laundry Order',
                                    details: customerData.items || 'Laundry service',
                                    points: orderPoints,
                                    timestamp: customerData.date ? new Date(customerData.date).getTime() : 
                                             (customerData.createdAt ? new Date(customerData.createdAt).getTime() : Date.now()),
                                    id: orderKey
                                });
                            }
                        }
                        
                        // Get points history for this customer
                        promises.push(
                            database.ref(`customers/${customerId}/pointsHistory`).once('value')
                                .then(historySnapshot => {
                                    if (historySnapshot.exists()) {
                                        historySnapshot.forEach(historyItem => {
                                            const item = historyItem.val();
                                            const itemKey = `points-${historyItem.key}`;
                                            
                                            // Skip if we've already processed this item
                                            if (seenItems.has(itemKey)) {
                                                return;
                                            }
                                            seenItems.add(itemKey);
                                            
                                            if (item.pointsAdded) {
                                                const points = parseInt(item.pointsAdded) || 0;
                                                if (points > 0) {
                                                    pointsHistory.push({
                                                        type: 'earned',
                                                        date: item.timestamp,
                                                        description: item.reason || 'Points Added',
                                                        details: item.addedBy ? `Added by: ${item.addedBy}` : '',
                                                        points: points,
                                                        timestamp: item.timestamp ? new Date(item.timestamp).getTime() : Date.now(),
                                                        id: itemKey
                                                    });
                                                    
                                                    totalEarned += points;
                                                }
                                            }
                                        });
                                    }
                                })
                        );
                        
                        // Get redemption history for this customer
                        promises.push(
                            database.ref('redemptions').orderByChild('customerEmail').equalTo(user.email).once('value')
                                .then(redemptionsSnapshot => {
                                    if (redemptionsSnapshot.exists()) {
                                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                                            const redemption = redemptionSnapshot.val();
                                            const redemptionId = redemptionSnapshot.key;
                                            const itemKey = `redeemed-${redemptionId}`;
                                            
                                            // Skip if we've already processed this redemption
                                            if (seenItems.has(itemKey)) {
                                                return;
                                            }
                                            seenItems.add(itemKey);
                                            
                                            if (redemption.pointsUsed) {
                                                const points = parseInt(redemption.pointsUsed) || 0;
                                                if (points > 0) {
                                                    pointsHistory.push({
                                                        type: 'redeemed',
                                                        date: redemption.timestamp,
                                                        description: 'Points Redeemed',
                                                        details: redemption.reward || 'Reward not specified',
                                                        points: points,
                                                        timestamp: redemption.timestamp ? new Date(redemption.timestamp).getTime() : Date.now(),
                                                        id: itemKey
                                                    });
                                                    
                                                    totalRedeemed += points;
                                                }
                                            }
                                        });
                                    }
                                })
                        );
                    });
                    
                    return Promise.all(promises);
                })
                .then(() => {
                    // Calculate the final balance based on earned minus redeemed
                    totalBalance = totalEarned - totalRedeemed;
                    
                    // Update points display
                    document.getElementById('points-balance').textContent = totalBalance;
                    document.getElementById('points-total-earned').textContent = totalEarned;
                    document.getElementById('points-total-redeemed').textContent = totalRedeemed;
                    
                    // Sort history by timestamp (newest first)
                    pointsHistory.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Render history with current filter
                    filterPointsHistory(currentFilter);
                })
                .catch(error => {
                    console.error('Error loading points data:', error);
                    document.getElementById('points-history-list').innerHTML = '<div class="empty-state"><div>❌</div><p>Error loading history: ' + error.message + '</p></div>';
                });
        }
        
        function filterPointsHistory(filter) {
            const historyList = document.getElementById('points-history-list');
            if (!historyList) return;
            
            if (pointsHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-state"><div>📊</div><p>No points history found</p></div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            const filteredHistory = pointsHistory.filter(item => {
                if (filter === 'all') return true;
                return item.type === filter;
            });
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-state"><div>🔍</div><p>No matching records found</p></div>';
                return;
            }
            
            filteredHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item-portal';
                
                let dateText = 'Date not available';
                if (item.date) {
                    try {
                        dateText = new Date(item.date).toLocaleDateString();
                    } catch (e) {
                        // If date is in a different format, try using timestamp
                        if (item.timestamp) {
                            dateText = new Date(item.timestamp).toLocaleDateString();
                        }
                    }
                } else if (item.timestamp) {
                    dateText = new Date(item.timestamp).toLocaleDateString();
                }
                
                historyItem.innerHTML = `
                    <div class="history-info">
                        <div class="history-date-portal">${dateText}</div>
                        <div class="history-desc">${item.description}</div>
                        <div class="history-details-portal">${item.details}</div>
                    </div>
                    <div class="points-change ${item.type === 'earned' ? 'points-added' : 'points-redeemed'}">
                        ${item.type === 'earned' ? '+' : '-'}${item.points}
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        function showPointsLoading() {
            const historyList = document.getElementById('points-history-list');
            if (historyList) {
                historyList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            }
        }
        
        // Set up points portal filter buttons
        function setupPointsPortalFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    filterPointsHistory(currentFilter);
                });
            });
        }
        
        // Admin dashboard functions
        function initAdminDashboard() {
            setupEventListeners();
            loadCustomers();
            loadCustomerProfiles();
            
            // Set today's date as default
            document.getElementById('customer-date-input').valueAsDate = new Date();
        }
        
        // Load customers from Firebase
        function loadCustomers() {
            showLoading();
            database.ref('customers').on('value', snapshot => {
                allCustomers = [];
                
                if (!snapshot.exists()) {
                    document.getElementById('customers-list').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No customers found</td></tr>';
                    hideLoading();
                    return;
                }
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    customer.id = child.key; // Store the Firebase key
                    
                    // Initialize points if not set
                    if (typeof customer.points === 'undefined') {
                        customer.points = 0;
                    }
                    
                    allCustomers.push(customer);
                });
                
                // Sort customers by date (newest first)
                allCustomers.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date) : new Date(0);
                    const dateB = b.date ? new Date(b.date) : new Date(0);
                    return dateB - dateA;
                });
                
                // Initial render
                renderCustomers(allCustomers);
                hideLoading();
            }, error => {
                console.error('Error loading customers:', error);
                hideLoading();
                alert('Error loading customer data');
            });
        }
        
        // Load customer profiles (unique customers)
        function loadCustomerProfiles() {
            database.ref('customers').once('value', snapshot => {
                allCustomerProfiles = [];
                const customerMap = new Map();
                
                if (!snapshot.exists()) {
                    document.getElementById('customer-history-list').innerHTML = '<p>No customer history found.</p>';
                    return;
                }
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    
                    // Create a unique key for each customer (email + phone)
                    const customerKey = `${customer.email}-${customer.phone}`;
                    
                    if (!customerMap.has(customerKey)) {
                        // This is a new customer, add to our map
                        customer.id = child.key;
                        customer.totalOrders = 1;
                        customer.totalPoints = parseInt(customer.points) || 0;
                        customerMap.set(customerKey, customer);
                    } else {
                        // Existing customer, update order count and points
                        const existingCustomer = customerMap.get(customerKey);
                        existingCustomer.totalOrders += 1;
                        existingCustomer.totalPoints += parseInt(customer.points) || 0;
                    }
                });
                
                // Convert map values to array
                allCustomerProfiles = Array.from(customerMap.values());
                
                // Sort customers by name
                allCustomerProfiles.sort((a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    return nameA.localeCompare(nameB);
                });
                
                // Render customer profiles
                renderCustomerProfiles(allCustomerProfiles);
            }, error => {
                console.error('Error loading customer profiles:', error);
                document.getElementById('customer-history-list').innerHTML = '<p>Error loading customer history.</p>';
            });
        }
        
        // Render customers based on current search
        function renderCustomers(customers) {
            const customersList = document.getElementById('customers-list');
            customersList.innerHTML = '';
            
            if (customers.length === 0) {
                customersList.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No customers found</td></tr>';
                return;
            }
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${customer.name || ''}</td>
                    <td>${customer.phone || customer.contact || ''}</td>
                    <td>${customer.email || ''}</td>
                    <td>${customer.items || customer.clothes || ''}</td>
                    <td>${customer.date || ''}</td>
                    <td class="status-${getStatusClass(customer)}">${formatStatus(customer)}</td>
                    <td><span class="points-badge">${customer.points || 0}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary edit-btn" data-id="${customer.id}">Edit</button>
                            <button class="btn btn-danger delete-btn" data-id="${customer.id}">Delete</button>
                            <button class="btn btn-warning quick-add-btn" data-id="${customer.id}">Quick Add</button>
                        </div>
                    </td>
                `;
                
                customersList.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editCustomer(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteCustomer(btn.dataset.id));
            });
            
            document.querySelectorAll('.quick-add-btn').forEach(btn => {
                btn.addEventListener('click', () => quickAddCustomer(btn.dataset.id));
            });
        }
        
        // Render customer profiles
        function renderCustomerProfiles(customers) {
            const customerHistoryList = document.getElementById('customer-history-list');
            customerHistoryList.innerHTML = '';
            
            if (customers.length === 0) {
                customerHistoryList.innerHTML = '<p>No customer history found.</p>';
                return;
            }
            
            customers.forEach(customer => {
                const customerCard = document.createElement('div');
                customerCard.className = 'customer-history-card';
                
                // Calculate points balance
                let pointsBalance = customer.totalPoints || 0;
                
                customerCard.innerHTML = `
                    <div class="customer-history-header">
                        <h3>${customer.name || 'Unknown Customer'}</h3>
                        <div>
                            <span class="points-earned-badge">${pointsBalance} earned</span>
                        </div>
                    </div>
                    <div class="customer-history-content">
                        <div class="customer-history-details">
                            <strong>Email:</strong> <span>${customer.email || 'N/A'}</span>
                            <strong>Phone:</strong> <span>${customer.phone || customer.contact || 'N/A'}</span>
                            <strong>Total Orders:</strong> <span>${customer.totalOrders || 0}</span>
                            <strong>Total Points Earned:</strong> <span class="points-earned-badge">${pointsBalance}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn history-btn view-history-btn" data-id="${customer.id}" data-email="${customer.email}">View Full History</button>
                            <button class="btn add-points-btn" data-id="${customer.id}">Add Points</button>
                            <button class="btn redeem-btn" data-id="${customer.id}">Redeem Points</button>
                        </div>
                    </div>
                `;
                
                customerHistoryList.appendChild(customerCard);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.addEventListener('click', () => openHistoryModal(btn.dataset.id));
            });
            
            document.querySelectorAll('.add-points-btn').forEach(btn => {
                btn.addEventListener('click', () => openAddPointsModal(btn.dataset.id));
            });
            
            document.querySelectorAll('.redeem-btn').forEach(btn => {
                btn.addEventListener('click', () => openRedeemModal(btn.dataset.id));
            });
        }
        
        // Format status for display
        function formatStatus(customer) {
            if (customer.collected) return 'Collected';
            if (customer.ready) return 'Ready';
            return 'Pending';
        }
        
        // Get status class for styling
        function getStatusClass(customer) {
            if (customer.collected) return 'collected';
            if (customer.ready) return 'ready';
            return 'pending';
        }
        
        // Open modal to add new customer
        function openAddCustomerModal() {
            document.getElementById('modal-title').textContent = 'Add New Customer';
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            document.getElementById('customer-points-input').value = '0';
            document.getElementById('customer-date-input').valueAsDate = new Date();
            document.getElementById('customer-modal').style.display = 'flex';
        }
        
        // Quick add - duplicate customer details except items
        function quickAddCustomer(customerId) {
            showLoading();
            const customer = allCustomers.find(c => c.id === customerId);
            
            if (!customer) {
                hideLoading();
                alert('Customer not found');
                return;
            }
            
            document.getElementById('modal-title').textContent = 'Quick Add (Duplicate)';
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            
            // Fill in all fields except items
            document.getElementById('customer-name-input').value = customer.name || '';
            document.getElementById('customer-phone-input').value = customer.phone || customer.contact || '';
            document.getElementById('customer-email-input').value = customer.email || '';
            document.getElementById('customer-date-input').valueAsDate = new Date(); // Use current date
            document.getElementById('customer-points-input').value = '0'; // Start new customers with 0 points
            
            // Set status to pending for new entry
            document.getElementById('customer-status-input').value = 'pending';
            
            // Focus on items field for quick entry
            document.getElementById('customer-modal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('customer-items-input').focus();
            }, 100);
            
            hideLoading();
        }
        
        // Open modal to edit existing customer
        function editCustomer(customerId) {
            showLoading();
            const customer = allCustomers.find(c => c.id === customerId);
            
            if (!customer) {
                hideLoading();
                alert('Customer not found');
                return;
            }
            
            document.getElementById('modal-title').textContent = 'Edit Customer';
            document.getElementById('customer-id').value = customerId;
            document.getElementById('customer-name-input').value = customer.name || '';
            document.getElementById('customer-phone-input').value = customer.phone || customer.contact || '';
            document.getElementById('customer-email-input').value = customer.email || '';
            document.getElementById('customer-items-input').value = customer.items || customer.clothes || '';
            document.getElementById('customer-date-input').value = customer.date || '';
            document.getElementById('customer-points-input').value = customer.points || 0;
            
            // Set status
            if (customer.collected) {
                document.getElementById('customer-status-input').value = 'collected';
            } else if (customer.ready) {
                document.getElementById('customer-status-input').value = 'ready';
            } else {
                document.getElementById('customer-status-input').value = 'pending';
            }
            
            document.getElementById('customer-modal').style.display = 'flex';
            hideLoading();
        }
        
        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const customerData = {
                name: document.getElementById('customer-name-input').value.trim(),
                phone: document.getElementById('customer-phone-input').value.trim(),
                email: document.getElementById('customer-email-input').value.trim(),
                items: document.getElementById('customer-items-input').value.trim(),
                date: document.getElementById('customer-date-input').value,
                points: parseInt(document.getElementById('customer-points-input').value) || 0,
                ready: document.getElementById('customer-status-input').value === 'ready',
                collected: document.getElementById('customer-status-input').value === 'collected',
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Validation
            if (!customerData.name || !customerData.phone || !customerData.items || !customerData.date) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!/^\d{10,15}$/.test(customerData.phone)) {
                alert('Please enter a valid phone number (10-15 digits');
                return;
            }
            
            showLoading();
            
            const customerId = document.getElementById('customer-id').value;
            if (customerId) {
                // Update existing customer
                database.ref('customers/' + customerId).update(customerData)
                    .then(() => {
                        document.getElementById('customer-modal').style.display = 'none';
                        document.getElementById('customer-form').reset();
                        document.getElementById('customer-id').value = '';
                        document.getElementById('customer-date-input').valueAsDate = new Date();
                    })
                    .catch(error => {
                        console.error('Error updating customer:', error);
                        alert('Error updating customer');
                    })
                    .finally(() => {
                        hideLoading();
                    });
            } else {
                // Add new customer
                customerData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                database.ref('customers').push(customerData)
                    .then(() => {
                        document.getElementById('customer-modal').style.display = 'none';
                        document.getElementById('customer-form').reset();
                        document.getElementById('customer-date-input').valueAsDate = new Date();
                    })
                    .catch(error => {
                        console.error('Error adding customer:', error);
                        alert('Error adding customer');
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }
        }
        
        // Delete customer
        function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            showLoading();
            database.ref('customers/' + customerId).remove()
                .then(() => {
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error deleting customer:', error);
                    hideLoading();
                    alert('Error deleting customer');
                });
        }
        
        // Open history modal
        function openHistoryModal(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            // Store the current customer ID for use in the history modal
            currentHistoryCustomerId = customerId;
            
            // Set customer details
            document.getElementById('history-title').textContent = `History: ${customer.name || 'Customer'}`;
            document.getElementById('history-customer-name').textContent = customer.name || 'N/A';
            document.getElementById('history-customer-phone').textContent = customer.phone || customer.contact || 'N/A';
            document.getElementById('history-customer-email').textContent = customer.email || 'N/A';
            
            // Reset summary counts
            document.getElementById('total-visits').textContent = '0';
            document.getElementById('total-orders').textContent = '0';
            document.getElementById('total-points-earned').textContent = '0';
            document.getElementById('total-points-redeemed').textContent = '0';
            
            // Show loading messages
            document.getElementById('order-history-list').innerHTML = '<p>Loading order history...</p>';
            document.getElementById('points-history-list').innerHTML = '<p>Loading points history...</p>';
            document.getElementById('redemption-history-list').innerHTML = '<p>Loading redemption history...</p>';
            
            // Show the modal
            document.getElementById('history-modal').style.display = 'flex';
            
            // Load customer history
            loadCustomerHistory(customerId, customer.email);
        }
        
        // Load customer history
        function loadCustomerHistory(customerId, customerEmail) {
            showLoading();
            
            // Initialize counters
            let totalVisits = 0;
            let totalOrders = 0;
            let totalPointsEarned = 0;
            let totalPointsRedeemed = 0;
            
            // Load order history
            database.ref('customers').orderByChild('email').equalTo(customerEmail).once('value')
                .then(ordersSnapshot => {
                    const orderHistoryList = document.getElementById('order-history-list');
                    orderHistoryList.innerHTML = '';
                    
                    if (!ordersSnapshot.exists()) {
                        orderHistoryList.innerHTML = '<p>No order history found.</p>';
                    } else {
                        let orders = [];
                        ordersSnapshot.forEach(orderSnapshot => {
                            const order = orderSnapshot.val();
                            order.id = orderSnapshot.key;
                            orders.push(order);
                            
                            // Count orders and visits
                            totalOrders++;
                            totalVisits++;
                            
                            // Count points earned from orders (sum of all loyalty points)
                            totalPointsEarned += parseInt(order.points) || 0;
                        });
                        
                        // Update order count badge
                        document.getElementById('order-count').textContent = `${totalOrders} orders`;
                        
                        // Sort orders by date (newest first)
                        orders.sort((a, b) => {
                            const dateA = a.date || a.createdAt || 0;
                            const dateB = b.date || b.createdAt || 0;
                            return new Date(dateB) - new Date(dateA);
                        });
                        
                        // Display orders
                        orders.forEach(order => {
                            const orderDate = order.date ? new Date(order.date).toLocaleDateString() : 
                                           (order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A');
                            
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-date">${orderDate}</div>
                                <div class="history-action">Order: ${order.items || 'N/A'}</div>
                                <div class="history-details">
                                    Status: ${getStatusText(order)} | 
                                    Loyalty Points: ${order.points || 0}
                                </div>
                            `;
                            orderHistoryList.appendChild(historyItem);
                        });
                    }
                    
                    // Load points history (but don't add these points to totalPointsEarned)
                    return database.ref(`customers/${customerId}/pointsHistory`).once('value');
                })
                .then(pointsSnapshot => {
                    const pointsHistoryList = document.getElementById('points-history-list');
                    pointsHistoryList.innerHTML = '';
                    
                    if (!pointsSnapshot.exists()) {
                        pointsHistoryList.innerHTML = '<p>No points history found.</p>';
                    } else {
                        let pointsHistory = [];
                        pointsSnapshot.forEach(pointSnapshot => {
                            const point = pointSnapshot.val();
                            point.id = pointSnapshot.key;
                            pointsHistory.push(point);
                        });
                        
                        // Update points count badge
                        document.getElementById('points-count').textContent = `${pointsHistory.length} events`;
                        
                        // Sort points history by timestamp (newest first)
                        pointsHistory.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Display points history
                        pointsHistory.forEach(point => {
                            const pointDate = point.timestamp ? new Date(point.timestamp).toLocaleDateString() : 'N/A';
                            
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-date">${pointDate}</div>
                                <div class="history-action">
                                    <span class="points-added">+${point.pointsAdded || 0} points</span>
                                </div>
                                <div class="history-details">
                                    Reason: ${point.reason || 'No reason provided'} | 
                                    Added by: ${point.addedBy || 'Admin'}
                                </div>
                            `;
                            pointsHistoryList.appendChild(historyItem);
                        });
                    }
                    
                    // Load redemption history
                    return database.ref('redemptions').orderByChild('customerId').equalTo(customerId).once('value');
                })
                .then(redemptionsSnapshot => {
                    const redemptionHistoryList = document.getElementById('redemption-history-list');
                    redemptionHistoryList.innerHTML = '';
                    
                    if (!redemptionsSnapshot.exists()) {
                        redemptionHistoryList.innerHTML = '<p>No redemption history found.</p>';
                    } else {
                        let redemptions = [];
                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                            const redemption = redemptionSnapshot.val();
                            redemption.id = redemptionSnapshot.key;
                            redemptions.push(redemption);
                            
                            // Count points redeemed
                            totalPointsRedeemed += parseInt(redemption.pointsUsed) || 0;
                        });
                        
                        // Update redemption count badge
                        document.getElementById('redemption-count').textContent = `${redemptions.length} redemptions`;
                        
                        // Sort redemptions by timestamp (newest first)
                        redemptions.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Display redemption history
                        redemptions.forEach(redemption => {
                            const redemptionDate = redemption.timestamp ? new Date(redemption.timestamp).toLocaleDateString() : 'N/A';
                            
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-date">${redemptionDate}</div>
                                <div class="history-action">
                                    <span class="points-redeemed">-${redemption.pointsUsed || 0} points</span>
                                </div>
                                <div class="history-details">
                                    Reward: ${redemption.reward || 'N/A'} | 
                                    Redeemed by: ${redemption.redeemedBy || 'Admin'}
                                </div>
                            `;
                            redemptionHistoryList.appendChild(historyItem);
                        });
                    }
                    
                    // Calculate points balance
                    const pointsBalance = totalPointsEarned - totalPointsRedeemed;
                    
                    // Update summary counts
                    document.getElementById('total-visits').textContent = totalVisits;
                    document.getElementById('total-orders').textContent = totalOrders;
                    document.getElementById('total-points-earned').textContent = totalPointsEarned;
                    document.getElementById('total-points-redeemed').textContent = totalPointsRedeemed;
                    
                    // Update points display in customer details
                    document.getElementById('history-customer-points-earned').textContent = totalPointsEarned;
                    document.getElementById('history-customer-points-balance').textContent = pointsBalance;
                })
                .catch(error => {
                    console.error('Error loading customer history:', error);
                    alert('Error loading customer history');
                })
                .finally(() => {
                    hideLoading();
                });
        }
        
        // Handle points form submission
        function handlePointsSubmit(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('points-customer-id').value;
            const pointsToAdd = parseInt(document.getElementById('points-amount').value);
            const reason = document.getElementById('points-reason').value.trim();
            
            if (!customerId || isNaN(pointsToAdd) || pointsToAdd <= 0) {
                alert('Please enter a valid points amount');
                return;
            }
            
            showLoading();
            
            // Get the customer data
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                hideLoading();
                alert('Customer not found');
                return;
            }
            
            // Get current points
            database.ref('customers/' + customerId + '/points').once('value')
                .then(snapshot => {
                    const currentPoints = snapshot.val() || 0;
                    const newPoints = currentPoints + pointsToAdd;
                    
                    // Prepare points history update
                    const pointsHistory = {
                        pointsAdded: pointsToAdd,
                        newTotal: newPoints,
                        reason: reason || 'No reason provided',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        addedBy: auth.currentUser.email || 'Admin'
                    };
                    
                    // Update points and history
                    const updates = {};
                    updates['customers/' + customerId + '/points'] = newPoints;
                    updates['customers/' + customerId + '/pointsHistory/' + Date.now()] = pointsHistory;
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    document.getElementById('points-modal').style.display = 'none';
                    document.getElementById('points-form').reset();
                    alert(`Successfully added ${pointsToAdd} points`);
                    
                    // Refresh the history view
                    if (currentHistoryCustomerId) {
                        const customer = allCustomers.find(c => c.id === currentHistoryCustomerId);
                        if (customer) {
                            loadCustomerHistory(currentHistoryCustomerId, customer.email);
                        }
                    }
                    
                    // Refresh customer profiles
                    loadCustomerProfiles();
                })
                .catch(error => {
                    console.error('Error adding points:', error);
                    alert('Error adding points');
                })
                .finally(() => {
                    hideLoading();
                });
        }
        
        // Handle redeem form submission
        function handleRedeemSubmit(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('redeem-customer-id').value;
            const pointsToRedeem = parseInt(document.getElementById('redeem-amount').value);
            const reason = document.getElementById('redeem-reason').value.trim();
            
            if (!customerId || isNaN(pointsToRedeem)) {
                alert('Please enter a valid points amount');
                return;
            }
            
            if (pointsToRedeem <= 0) {
                alert('Points to redeem must be positive');
                return;
            }
            
            if (!reason) {
                alert('Please enter a reward/reason');
                return;
            }
            
            showLoading();
            
            // Get the customer data
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                hideLoading();
                alert('Customer not found');
                return;
            }
            
            // Get the customer's email for the redemption record
            const customerEmail = customer ? customer.email : '';
            
            // Calculate points balance (earned - redeemed)
            let totalPointsEarned = 0;
            let totalPointsRedeemed = 0;
            
            // First get all orders to calculate earned points
            database.ref('customers').orderByChild('email').equalTo(customerEmail).once('value')
                .then(ordersSnapshot => {
                    if (ordersSnapshot.exists()) {
                        ordersSnapshot.forEach(orderSnapshot => {
                            const order = orderSnapshot.val();
                            totalPointsEarned += parseInt(order.points) || 0;
                        });
                    }
                    
                    // Then get all redemptions to calculate redeemed points
                    return database.ref('redemptions').orderByChild('customerId').equalTo(customerId).once('value');
                })
                .then(redemptionsSnapshot => {
                    if (redemptionsSnapshot.exists()) {
                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                            const redemption = redemptionSnapshot.val();
                            totalPointsRedeemed += parseInt(redemption.pointsUsed) || 0;
                        });
                    }
                    
                    // Calculate points balance
                    const pointsBalance = totalPointsEarned - totalPointsRedeemed;
                    
                    // Check if customer has enough points
                    if (pointsToRedeem > pointsBalance) {
                        alert('Customer does not have enough points');
                        hideLoading();
                        return;
                    }
                    
                    // Prepare redemption record
                    const redemptionData = {
                        customerId: customerId,
                        customerEmail: customerEmail,
                        pointsUsed: pointsToRedeem,
                        reward: reason,
                        redeemedBy: auth.currentUser.email || 'Admin',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Create redemption record
                    return database.ref('redemptions/' + Date.now()).set(redemptionData);
                })
                .then(() => {
                    document.getElementById('redeem-modal').style.display = 'none';
                    document.getElementById('redeem-form').reset();
                    alert(`Successfully redeemed ${pointsToRedeem} points for: ${reason}`);
                    
                    // Refresh the history view
                    if (currentHistoryCustomerId) {
                        const customer = allCustomers.find(c => c.id === currentHistoryCustomerId);
                        if (customer) {
                            loadCustomerHistory(currentHistoryCustomerId, customer.email);
                        }
                    }
                    
                    // Refresh customer profiles
                    loadCustomerProfiles();
                })
                .catch(error => {
                    console.error('Error redeeming points:', error);
                    alert('Error redeeming points');
                })
                .finally(() => {
                    hideLoading();
                });
        }
        
        // Filter customers based on search term
        function filterCustomers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderCustomers(allCustomers);
                return;
            }
            
            const filtered = allCustomers.filter(customer => {
                // Search in name
                if (customer.name && customer.name.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                // Search in phone/contact
                if ((customer.phone && customer.phone.toLowerCase().includes(searchTerm)) || 
                    (customer.contact && customer.contact.toLowerCase().includes(searchTerm))) {
                    return true;
                }
                
                // Search in email
                if (customer.email && customer.email.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                // Search in items/clothes
                if ((customer.items && customer.items.toLowerCase().includes(searchTerm)) || 
                    (customer.clothes && customer.clothes.toLowerCase().includes(searchTerm))) {
                    return true;
                }
                
                // Search in status
                const status = formatStatus(customer).toLowerCase();
                if (status.includes(searchTerm)) {
                    return true;
                }
                
                // Search in points
                if (customer.points && customer.points.toString().includes(searchTerm)) {
                    return true;
                }
                
                return false;
            });
            
            renderCustomers(filtered);
        }
        
        // Filter customer profiles based on search term
        function filterCustomerProfiles() {
            const searchTerm = document.getElementById('customer-search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderCustomerProfiles(allCustomerProfiles);
                return;
            }
            
            const filtered = allCustomerProfiles.filter(customer => {
                // Search in name
                if (customer.name && customer.name.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                // Search in phone/contact
                if ((customer.phone && customer.phone.toLowerCase().includes(searchTerm)) || 
                    (customer.contact && customer.contact.toLowerCase().includes(searchTerm))) {
                    return true;
                }
                
                // Search in email
                if (customer.email && customer.email.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                return false;
            });
            
            renderCustomerProfiles(filtered);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('add-customer-btn').addEventListener('click', openAddCustomerModal);
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('customer-modal').style.display = 'none';
            });
            
            document.getElementById('close-points-modal').addEventListener('click', () => {
                document.getElementById('points-modal').style.display = 'none';
            });
            
            document.getElementById('close-redeem-modal').addEventListener('click', () => {
                document.getElementById('redeem-modal').style.display = 'none';
            });
            
            document.getElementById('close-history-modal').addEventListener('click', () => {
                document.getElementById('history-modal').style.display = 'none';
            });
            
            document.getElementById('customer-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('points-form').addEventListener('submit', handlePointsSubmit);
            document.getElementById('redeem-form').addEventListener('submit', handleRedeemSubmit);
            
            // Search functionality
            document.getElementById('search-input').addEventListener('input', filterCustomers);
            document.getElementById('clear-search-btn').addEventListener('click', () => {
                document.getElementById('search-input').value = '';
                filterCustomers();
            });
            
            // Customer search functionality
            document.getElementById('customer-search-input').addEventListener('input', filterCustomerProfiles);
            document.getElementById('clear-customer-search-btn').addEventListener('click', () => {
                document.getElementById('customer-search-input').value = '';
                filterCustomerProfiles();
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
            
            // Mobile back button functionality
            document.getElementById('mobile-back-btn').addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('data-tab') === 'orders') {
                        tab.click();
                    }
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('customer-modal')) {
                    document.getElementById('customer-modal').style.display = 'none';
                }
                if (e.target === document.getElementById('points-modal')) {
                    document.getElementById('points-modal').style.display = 'none';
                }
                if (e.target === document.getElementById('redeem-modal')) {
                    document.getElementById('redeem-modal').style.display = 'none';
                }
                if (e.target === document.getElementById('history-modal')) {
                    document.getElementById('history-modal').style.display = 'none';
                }
            });
            
            // Set up points portal filter buttons
            setupPointsPortalFilters();
        }
        
        // Open modal to add points
        function openAddPointsModal(customerId) {
            // Find customer in allCustomers array
            let customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                // If not found in allCustomers, try to find in allCustomerProfiles
                const profile = allCustomerProfiles.find(c => c.id === customerId);
                if (!profile) {
                    alert('Customer not found');
                    return;
                }
                // Create a minimal customer object from profile
                customer = {
                    id: profile.id,
                    name: profile.name,
                    email: profile.email,
                    phone: profile.phone,
                    points: profile.totalPoints || 0
                };
            }
            
            document.getElementById('points-customer-id').value = customerId;
            document.getElementById('points-modal').style.display = 'flex';
            document.getElementById('points-amount').focus();
        }
        
        // Open redeem modal
        function openRedeemModal(customerId) {
            // Find customer in allCustomers array
            let customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                // If not found in allCustomers, try to find in allCustomerProfiles
                const profile = allCustomerProfiles.find(c => c.id === customerId);
                if (!profile) {
                    alert('Customer not found');
                    return;
                }
                // Create a minimal customer object from profile
                customer = {
                    id: profile.id,
                    name: profile.name,
                    email: profile.email,
                    phone: profile.phone,
                    points: profile.totalPoints || 0
                };
            }
            
            document.getElementById('redeem-customer-id').value = customerId;
            
            // Calculate points balance (earned - redeemed)
            let totalPointsEarned = 0;
            let totalPointsRedeemed = 0;
            
            // First get all orders to calculate earned points
            database.ref('customers').orderByChild('email').equalTo(customer.email).once('value')
                .then(ordersSnapshot => {
                    if (ordersSnapshot.exists()) {
                        ordersSnapshot.forEach(orderSnapshot => {
                            const order = orderSnapshot.val();
                            totalPointsEarned += parseInt(order.points) || 0;
                        });
                    }
                    
                    // Then get all redemptions to calculate redeemed points
                    return database.ref('redemptions').orderByChild('customerId').equalTo(customerId).once('value');
                })
                .then(redemptionsSnapshot => {
                    if (redemptionsSnapshot.exists()) {
                        redemptionsSnapshot.forEach(redemptionSnapshot => {
                            const redemption = redemptionSnapshot.val();
                            totalPointsRedeemed += parseInt(redemption.pointsUsed) || 0;
                        });
                    }
                    
                    // Calculate points balance
                    const pointsBalance = totalPointsEarned - totalPointsRedeemed;
                    
                    // Update points balance display
                    document.getElementById('points-balance-display').textContent = pointsBalance;
                    document.getElementById('redeem-amount').max = pointsBalance;
                    
                    // Show the modal
                    document.getElementById('redeem-modal').style.display = 'flex';
                    document.getElementById('redeem-amount').focus();
                })
                .catch(error => {
                    console.error('Error calculating points balance:', error);
                    alert('Error calculating points balance');
                });
        }
        
        // Show loading indicator
        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'flex';
        }
        
        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }
        
        // Create admin account function
        function createAdminAccount() {
            console.log("Attempting to create admin account...");
            const adminEmail = "golden31joseph@gmail.com";
            const adminPassword = "Golden";
            
            auth.createUserWithEmailAndPassword(adminEmail, adminPassword)
                .then((userCredential) => {
                    const userId = userCredential.user.uid;
                    return database.ref('users/' + userId).set({
                        name: "Admin",
                        email: adminEmail,
                        role: "admin",
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                })
                .then(() => {
                    console.log("Admin account created successfully");
                    document.getElementById('admin-error-message').textContent = "Admin account created! Please login again.";
                    document.getElementById('admin-error-message').className = 'success-message';
                })
                .catch((error) => {
                    console.error("Error creating admin account:", error);
                    if (error.code === 'auth/email-already-in-use') {
                        document.getElementById('admin-error-message').textContent = "Admin account exists but has incorrect permissions";
                    } else {
                        document.getElementById('admin-error-message').textContent = "Error creating admin account: " + error.message;
                    }
                });
        }
        
        // Check authentication state on page load
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check if user is admin or customer
                database.ref('users/' + user.uid).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.role === 'admin') {
                            showAdminLanding();
                        } else {
                            showCustomerLanding();
                        }
                    })
                    .catch((error) => {
                        console.error('Error checking user role:', error);
                        showSelection();
                    });
            } else {
                showSelection();
            }
        });

        // Initialize the application
        window.onload = function() {
            setupEventListeners();
        };
    </script>
</body>
</html>
